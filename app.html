<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Running Coach</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --hint: var(--tg-theme-hint-color, #999999);
    --link: var(--tg-theme-link-color, #2678b6);
    --btn: var(--tg-theme-button-color, #2678b6);
    --btn-text: var(--tg-theme-button-text-color, #ffffff);
    --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
    --section-bg: var(--tg-theme-section-bg-color, var(--bg));
    --card-radius: 16px;
    --shimmer-color: rgba(128,128,128,0.08);
    --success: #22c55e;
    --core-color: #F59E0B;
    --method-color: #8B5CF6;
    --stretch-color: #EAB308;
    --nav-height: 56px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--secondary-bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom) + 8px);
  }

  .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }

  /* Tab content */
  .tab-content { display: none; padding-top: 12px; padding-bottom: 16px; }
  .tab-content.active { display: block; animation: fadeIn 0.25s ease; }

  /* Bottom Navigation */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 50;
    background: var(--bg);
    border-top: 1px solid var(--secondary-bg);
    padding-bottom: env(safe-area-inset-bottom);
  }
  .bottom-nav-inner {
    max-width: 480px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-around;
  }
  .nav-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 8px 0 6px;
    border: none;
    background: transparent;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: color 0.15s;
    color: var(--hint);
  }
  .nav-btn.active { color: var(--btn); }
  .nav-btn svg { width: 22px; height: 22px; }
  .nav-btn.active svg { stroke-width: 2.5; }
  .nav-btn span { font-size: 10px; font-weight: 500; }
  .nav-btn.active span { font-weight: 700; }

  /* Card base */
  .card {
    background: var(--bg);
    border-radius: var(--card-radius);
    padding: 16px;
    margin-bottom: 12px;
  }

  /* Loading skeleton */
  .skeleton { display: flex; flex-direction: column; gap: 12px; padding-top: 20px; }
  .sk-block {
    background: var(--bg);
    border-radius: var(--card-radius);
    position: relative;
    overflow: hidden;
  }
  .sk-block::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent 0%, var(--shimmer-color) 50%, transparent 100%);
    animation: shimmer 1.5s infinite;
  }
  .sk-1 { height: 120px; }
  .sk-2 { height: 80px; }
  .sk-3 { height: 200px; }
  .sk-4 { height: 160px; }

  /* Error */
  .error-container { text-align: center; padding: 60px 20px; }
  .error-icon { font-size: 48px; margin-bottom: 16px; }
  .error-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .error-msg { font-size: 14px; color: var(--hint); line-height: 1.5; }
  .error-retry {
    margin-top: 20px;
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    background: var(--btn);
    color: var(--btn-text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  /* ===== HOME TAB ===== */
  .home-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 4px;
  }
  .home-greeting { font-size: 13px; color: var(--hint); }
  .home-name { font-size: 20px; font-weight: 700; }
  .streak-badge {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    background: rgba(239,68,68,0.1);
    font-size: 13px;
    font-weight: 700;
    color: #ef4444;
  }
  .xp-section { margin-bottom: 16px; }
  .xp-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 6px;
  }
  .xp-level { font-size: 14px; font-weight: 700; }
  .xp-text { font-size: 12px; color: var(--hint); }
  .xp-bar {
    height: 10px;
    background: var(--secondary-bg);
    border-radius: 5px;
    overflow: hidden;
  }
  .xp-fill {
    height: 100%;
    border-radius: 5px;
    background: linear-gradient(90deg, var(--btn), var(--link));
    transition: width 0.8s ease;
    position: relative;
    overflow: hidden;
  }
  .xp-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    animation: shimmer 2s infinite;
  }

  .quick-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }
  .qs-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 12px 6px;
    background: var(--bg);
    border-radius: 14px;
    border: 1px solid var(--secondary-bg);
  }
  .qs-icon { font-size: 20px; margin-bottom: 4px; }
  .qs-value { font-size: 18px; font-weight: 700; }
  .qs-label { font-size: 10px; color: var(--hint); margin-top: 2px; }

  .section-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .section-title .count { font-size: 12px; color: var(--hint); font-weight: 500; }

  .quest-list { display: flex; flex-direction: column; gap: 8px; }
  .quest-card {
    background: var(--bg);
    border-radius: 12px;
    padding: 12px 12px 12px 16px;
    position: relative;
    overflow: hidden;
  }
  .quest-card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
  }
  .quest-card[data-type="core"]::before { background: var(--core-color); }
  .quest-card[data-type="method"]::before { background: var(--method-color); }
  .quest-card[data-type="stretch"]::before { background: var(--stretch-color); }
  .quest-card.completed { background: rgba(34,197,94,0.06); }
  .quest-card.completed::after {
    content: '\2713';
    position: absolute;
    right: 12px; top: 12px;
    font-size: 18px;
    color: var(--success);
    font-weight: 700;
  }
  .quest-top { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .quest-pill {
    font-size: 10px;
    font-weight: 600;
    padding: 2px 7px;
    border-radius: 20px;
    color: #fff;
  }
  .quest-pill.core { background: var(--core-color); }
  .quest-pill.method { background: var(--method-color); }
  .quest-pill.stretch { background: var(--stretch-color); }
  .quest-xp { font-size: 10px; font-weight: 600; color: var(--link); margin-left: auto; }
  .quest-title { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
  .quest-progress-bar {
    height: 6px;
    background: var(--secondary-bg);
    border-radius: 3px;
    overflow: hidden;
  }
  .quest-progress-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 0.6s ease;
  }
  .quest-card[data-type="core"] .quest-progress-fill { background: var(--core-color); }
  .quest-card[data-type="method"] .quest-progress-fill { background: var(--method-color); }
  .quest-card[data-type="stretch"] .quest-progress-fill { background: var(--stretch-color); }
  .quest-card.completed .quest-progress-fill { background: var(--success); }
  .quest-progress-text { font-size: 11px; color: var(--hint); margin-top: 3px; text-align: right; }
  .quest-empty {
    text-align: center;
    padding: 24px 16px;
    color: var(--hint);
    background: var(--bg);
    border-radius: var(--card-radius);
    font-size: 13px;
  }

  /* ===== QUEST PATH TAB ===== */
  .quest-path-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .quest-path-sub { font-size: 13px; color: var(--hint); margin-bottom: 20px; }

  .path-container { position: relative; }
  .path-line {
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--secondary-bg);
  }
  .path-stages { display: flex; flex-direction: column; gap: 10px; }

  .stage-item { position: relative; }
  .stage-node {
    position: absolute;
    left: 20px;
    top: 16px;
    transform: translateX(-50%);
    z-index: 2;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    border: 3px solid var(--secondary-bg);
    background: var(--bg);
    color: var(--hint);
  }
  .stage-item.completed .stage-node {
    border-color: var(--btn);
    background: var(--btn);
    color: var(--btn-text);
  }
  .stage-item.current .stage-node {
    border-color: var(--btn);
    color: var(--btn);
    animation: pulse 2s infinite;
  }

  .stage-card {
    margin-left: 48px;
    border-radius: 14px;
    padding: 14px;
    border: 1px solid var(--secondary-bg);
    background: var(--bg);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: all 0.2s;
  }
  .stage-item.completed .stage-card {
    border-color: rgba(var(--btn-rgb, 38,120,182), 0.15);
    background: rgba(var(--btn-rgb, 38,120,182), 0.03);
  }
  .stage-item.current .stage-card {
    border-color: var(--btn);
    box-shadow: 0 2px 12px rgba(var(--btn-rgb, 38,120,182), 0.1);
  }
  .stage-item.locked .stage-card {
    opacity: 0.5;
    cursor: default;
  }
  .stage-head { display: flex; align-items: center; justify-content: space-between; }
  .stage-meta { display: flex; align-items: center; gap: 6px; }
  .stage-lv { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--hint); }
  .stage-item.completed .stage-lv,
  .stage-item.current .stage-lv { color: var(--btn); }
  .stage-now-badge {
    font-size: 9px;
    font-weight: 700;
    padding: 1px 6px;
    border-radius: 10px;
    background: var(--btn);
    color: var(--btn-text);
  }
  .stage-count { font-size: 12px; color: var(--hint); }
  .stage-chevron { font-size: 14px; color: var(--hint); transition: transform 0.2s; }
  .stage-chevron.open { transform: rotate(180deg); }
  .stage-title { font-size: 15px; font-weight: 700; margin-top: 4px; }
  .stage-item.locked .stage-title { color: var(--hint); }
  .stage-desc { font-size: 12px; color: var(--hint); margin-top: 2px; }

  .stage-progress-bar {
    margin-top: 10px;
    height: 4px;
    background: var(--secondary-bg);
    border-radius: 2px;
    overflow: hidden;
  }
  .stage-progress-fill {
    height: 100%;
    border-radius: 2px;
    background: var(--btn);
    transition: width 0.6s ease;
  }

  .stage-missions {
    margin-top: 8px;
    padding: 10px;
    background: var(--secondary-bg);
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .mission-row { display: flex; align-items: center; gap: 8px; padding: 4px; }
  .mission-check {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
  }
  .mission-check.done { background: var(--btn); color: var(--btn-text); }
  .mission-check.pending { border: 2px solid var(--hint); opacity: 0.4; }
  .mission-name { font-size: 13px; }
  .mission-row.done .mission-name { font-weight: 500; }
  .mission-row.pending .mission-name { color: var(--hint); }

  .trophy-final {
    position: relative;
    margin-top: 10px;
  }
  .trophy-node {
    position: absolute;
    left: 20px;
    top: 10px;
    transform: translateX(-50%);
    z-index: 2;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    background: var(--secondary-bg);
  }
  .trophy-card {
    margin-left: 48px;
    border-radius: 14px;
    padding: 14px;
    border: 1px solid var(--secondary-bg);
    background: var(--bg);
  }
  .trophy-title { font-size: 15px; font-weight: 700; }
  .trophy-desc { font-size: 12px; color: var(--hint); margin-top: 2px; }

  /* ===== STATS TAB ===== */
  .stats-page-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .stats-page-sub { font-size: 13px; color: var(--hint); margin-bottom: 16px; }

  .period-toggle {
    display: flex;
    border-radius: 12px;
    background: var(--bg);
    padding: 3px;
    margin-bottom: 16px;
  }
  .period-btn {
    flex: 1;
    padding: 8px 0;
    border: none;
    border-radius: 10px;
    background: transparent;
    font-size: 13px;
    font-weight: 500;
    color: var(--hint);
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  .period-btn.active {
    background: var(--btn);
    color: var(--btn-text);
    font-weight: 600;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 16px;
  }
  .stats-card {
    background: var(--bg);
    border-radius: 14px;
    padding: 14px;
    border: 1px solid var(--secondary-bg);
  }
  .stats-card-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    margin-bottom: 8px;
  }
  .stats-card-value { font-size: 22px; font-weight: 700; }
  .stats-card-label { font-size: 11px; color: var(--hint); margin-top: 2px; }

  .chart-card {
    background: var(--bg);
    border-radius: var(--card-radius);
    padding: 16px;
    margin-bottom: 12px;
    border: 1px solid var(--secondary-bg);
  }
  .chart-title { font-size: 15px; font-weight: 600; margin-bottom: 14px; }
  .bar-chart {
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 6px;
    height: 110px;
  }
  .bar-col {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    height: 100%;
    justify-content: flex-end;
  }
  .bar-value { font-size: 9px; font-weight: 600; color: var(--text); }
  .bar-fill {
    width: 100%;
    border-radius: 6px;
    transition: height 0.6s ease;
    min-height: 4px;
  }
  .bar-fill.has-data { background: var(--btn); }
  .bar-fill.no-data { background: var(--secondary-bg); height: 4px !important; }
  .bar-label { font-size: 10px; color: var(--hint); }

  .records-list { display: flex; flex-direction: column; gap: 8px; }
  .record-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: var(--bg);
    border-radius: 12px;
    border: 1px solid var(--secondary-bg);
  }
  .record-left { display: flex; align-items: center; gap: 10px; }
  .record-icon { font-size: 20px; }
  .record-label { font-size: 14px; }
  .record-value { font-size: 15px; font-weight: 700; }

  /* ===== PROFILE TAB ===== */
  .profile-header-card { animation: fadeIn 0.4s ease; }
  .profile-top { display: flex; align-items: center; gap: 14px; }
  .avatar { position: relative; flex-shrink: 0; }
  .avatar-circle {
    width: 60px; height: 60px;
    border-radius: 50%;
    background: var(--btn);
    color: var(--btn-text);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; font-weight: 700;
  }
  .avatar-badge {
    position: absolute; bottom: -2px; right: -2px;
    width: 22px; height: 22px;
    border-radius: 50%;
    background: var(--link);
    color: #fff;
    font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid var(--bg);
  }
  .profile-info { flex: 1; min-width: 0; }
  .profile-name { font-size: 18px; font-weight: 700; }
  .profile-since { font-size: 12px; color: var(--hint); margin-top: 2px; }
  .profile-xp-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .profile-xp-bar { flex: 1; height: 8px; background: var(--secondary-bg); border-radius: 4px; overflow: hidden; }
  .profile-xp-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--btn), var(--link)); transition: width 0.8s ease; }
  .profile-xp-label { font-size: 11px; font-weight: 600; color: var(--hint); white-space: nowrap; }

  .profile-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    margin-top: 14px;
  }
  .ps-item {
    display: flex; flex-direction: column; align-items: center;
    padding: 8px 4px;
    background: var(--secondary-bg);
    border-radius: 10px;
  }
  .ps-value { font-size: 15px; font-weight: 700; }
  .ps-label { font-size: 10px; color: var(--hint); margin-top: 1px; }

  .roadmap-title {
    font-size: 15px; font-weight: 600;
    margin-bottom: 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .level-list { display: flex; flex-direction: column; gap: 4px; }
  .level-row {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 8px;
    border-radius: 10px;
    transition: background 0.2s;
  }
  .level-row.reached { background: rgba(var(--btn-rgb, 38,120,182), 0.05); }
  .level-row.current { background: rgba(var(--btn-rgb, 38,120,182), 0.12); border: 1.5px solid var(--btn); }
  .level-row.locked { background: var(--secondary-bg); opacity: 0.5; }
  .lv-icon-box {
    width: 32px; height: 32px;
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; flex-shrink: 0;
  }
  .level-row.reached .lv-icon-box,
  .level-row.current .lv-icon-box { background: var(--btn); color: var(--btn-text); font-size: 11px; font-weight: 700; }
  .level-row.locked .lv-icon-box { background: var(--secondary-bg); }
  .lv-info { flex: 1; min-width: 0; }
  .lv-title { font-size: 13px; font-weight: 600; }
  .lv-xp { font-size: 10px; color: var(--hint); }
  .level-row.locked .lv-title { color: var(--hint); }
  .lv-tag { font-size: 10px; font-weight: 600; color: var(--btn); padding: 1px 7px; border-radius: 8px; background: rgba(var(--btn-rgb, 38,120,182), 0.1); }
  .lv-tag.current-tag { background: var(--btn); color: var(--btn-text); }

  .milestones-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; }
  .milestones-title .mcount { font-size: 12px; font-weight: 400; color: var(--hint); }
  .milestone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .ms-card {
    background: var(--bg);
    border-radius: 12px;
    padding: 10px 6px;
    text-align: center;
    position: relative;
    border: 1px solid rgba(var(--btn-rgb, 38,120,182), 0.12);
  }
  .ms-card.locked { opacity: 0.5; border-color: transparent; background: var(--secondary-bg); }
  .ms-icon { font-size: 24px; line-height: 1; }
  .ms-card.locked .ms-icon { filter: grayscale(1); }
  .ms-title { font-size: 10px; font-weight: 600; margin-top: 4px; line-height: 1.3; }
  .ms-date { font-size: 9px; color: var(--hint); margin-top: 2px; }
  .ms-lock { font-size: 9px; position: absolute; top: 4px; right: 4px; }
  .ms-prog-bar { margin-top: 4px; height: 3px; background: rgba(128,128,128,0.15); border-radius: 2px; overflow: hidden; }
  .ms-prog-fill { height: 100%; background: var(--hint); border-radius: 2px; }
  .ms-prog-text { font-size: 8px; color: var(--hint); margin-top: 1px; }

  .cta-section { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
  .btn-primary {
    display: block; width: 100%; padding: 12px;
    border: none; border-radius: 12px;
    background: var(--btn); color: var(--btn-text);
    font-size: 14px; font-weight: 600;
    cursor: pointer; text-align: center; text-decoration: none;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-secondary {
    display: block; width: 100%; padding: 12px;
    border: 1.5px solid var(--hint); border-radius: 12px;
    background: transparent; color: var(--text);
    font-size: 14px; font-weight: 600;
    cursor: pointer; text-align: center;
    -webkit-tap-highlight-color: transparent;
  }

  /* Animations */
  @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
</style>
</head>
<body>

<div class="container" id="app">
  <div class="skeleton" id="loading">
    <div class="sk-block sk-1"></div>
    <div class="sk-block sk-2"></div>
    <div class="sk-block sk-3"></div>
    <div class="sk-block sk-4"></div>
  </div>
</div>

<!-- Bottom Navigation -->
<nav class="bottom-nav" id="bottom-nav" style="display:none">
  <div class="bottom-nav-inner">
    <button class="nav-btn active" data-tab="home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>홈</span>
    </button>
    <button class="nav-btn" data-tab="quest">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></svg>
      <span>퀘스트</span>
    </button>
    <button class="nav-btn" data-tab="stats">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span>기록</span>
    </button>
    <button class="nav-btn" data-tab="profile">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>프로필</span>
    </button>
  </div>
</nav>

<script>
(function() {
  var API_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/rc-onboarding';
  var SURVEY_URL = 'https://michaeldohyun.github.io/rc-webapp/survey.html';

  var QUEST_XP = { core: 30, method: 40, stretch: 50 };
  var QUEST_TYPE_LABELS = { core: '\uD575\uC2EC', method: '\uD6C8\uB828\uBC95', stretch: '\uB3C4\uC804' };

  var XP_LEVELS = [
    { level: 1,  title: '\uCCAB \uBC1C\uC790\uAD6D',       min_xp: 0,     icon: '\uD83D\uDC5F' },
    { level: 2,  title: '\uC6CC\uBC0D\uC5C5 \uB7EC\uB108',     min_xp: 100,   icon: '\uD83C\uDFC3' },
    { level: 3,  title: '\uB9AC\uB4EC\uC744 \uCC3E\uB294 \uB7EC\uB108', min_xp: 300,   icon: '\uD83C\uDFBD' },
    { level: 4,  title: '\uAFB8\uC900\uD55C \uB7EC\uB108',     min_xp: 650,   icon: '\uD83D\uDCAA' },
    { level: 5,  title: '\uB3C4\uC804\uD558\uB294 \uB7EC\uB108',   min_xp: 1150,  icon: '\u26A1' },
    { level: 6,  title: '\uD398\uC774\uC2A4\uBA54\uC774\uCEE4',     min_xp: 1850,  icon: '\uD83C\uDFC5' },
    { level: 7,  title: '\uD6C8\uB828\uC758 \uB2EC\uC778',     min_xp: 2850,  icon: '\uD83C\uDFC6' },
    { level: 8,  title: '\uB9C8\uB77C\uD1A0\uB108',         min_xp: 4350,  icon: '\uD83E\uDD47' },
    { level: 9,  title: '\uB7EC\uB2DD \uB9C8\uC2A4\uD130',     min_xp: 6350,  icon: '\uD83D\uDC51' },
    { level: 10, title: '\uC804\uC124\uC758 \uB7EC\uB108',     min_xp: 9350,  icon: '\uD83D\uDC09' },
  ];

  // State
  var appData = null;
  var activeTab = 'home';
  var expandedStage = null;
  var statsPeriod = 'week';

  var tg = window.Telegram && window.Telegram.WebApp;
  var initData = '';
  var userId = null;

  if (tg) {
    tg.ready();
    tg.expand();
    initData = tg.initData || '';
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      userId = tg.initDataUnsafe.user.id;
    }
  }

  // URL param for deeplink
  var params = new URLSearchParams(window.location.search);
  var tabParam = params.get('tab');
  if (tabParam && ['home', 'quest', 'stats', 'profile'].indexOf(tabParam) !== -1) {
    activeTab = tabParam;
  }

  function esc(str) {
    var d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function formatDate(ds) {
    if (!ds) return '';
    var d = new Date(ds);
    return d.getFullYear() + '.' + String(d.getMonth()+1).padStart(2,'0') + '.' + String(d.getDate()).padStart(2,'0');
  }

  function fmtNum(n) {
    if (n >= 10000) return (n/10000).toFixed(1) + '\uB9CC';
    if (n >= 1000) return n.toLocaleString();
    return String(n);
  }

  function fmtMin(m) {
    if (m >= 60) { var h = Math.floor(m/60); var mm = m % 60; return h + 'h ' + mm + 'm'; }
    return m + 'm';
  }

  // -------------------------------------------------------
  // Fetch data
  // -------------------------------------------------------
  async function fetchAppData() {
    if (!userId) throw new Error('\uD154\uB808\uADF8\uB7A8\uC5D0\uC11C \uC5F4\uC5B4\uC8FC\uC138\uC694');
    var res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'get_app_data', telegram_user_id: userId, init_data: initData })
    });
    if (!res.ok) throw new Error('\uC11C\uBC84 \uC624\uB958 (' + res.status + ')');
    var data = await res.json();
    if (!data.success) throw new Error(data.error || '\uB370\uC774\uD130\uB97C \uBD88\uB7EC\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4');
    return data;
  }

  // -------------------------------------------------------
  // HOME TAB
  // -------------------------------------------------------
  function renderHome(d) {
    var h = d.home;
    var lvl = h.level;
    var s = h.streak;
    var qs = h.quick_stats;
    var xpPct = lvl.next_level_xp > 0 ? Math.min(100, (lvl.current_xp / lvl.next_level_xp) * 100) : 100;

    var html = '';
    // Header
    html += '<div class="home-header">' +
      '<div><div class="home-greeting">\uC548\uB155\uD558\uC138\uC694,</div><div class="home-name">' + esc(h.name) + '</div></div>';
    if (s.current_weeks > 0) {
      html += '<div class="streak-badge">\uD83D\uDD25 ' + s.current_weeks + '\uC8FC</div>';
    }
    html += '</div>';

    // XP
    html += '<div class="xp-section card">' +
      '<div class="xp-header"><span class="xp-level">' + lvl.icon + ' Lv.' + lvl.xp_level + ' ' + esc(lvl.title) + '</span>' +
      '<span class="xp-text">' + lvl.current_xp + ' / ' + lvl.next_level_xp + ' XP</span></div>' +
      '<div class="xp-bar"><div class="xp-fill" style="width:' + xpPct + '%"></div></div>' +
    '</div>';

    // Quick Stats
    html += '<div class="quick-stats">' +
      '<div class="qs-item"><div class="qs-icon">\uD83C\uDFC3</div><div class="qs-value">' + fmtNum(qs.total_runs) + '</div><div class="qs-label">\uCD1D \uB7EC\uB2DD</div></div>' +
      '<div class="qs-item"><div class="qs-icon">\uD83D\uDCCD</div><div class="qs-value">' + qs.total_distance_km + '</div><div class="qs-label">\uCD1D \uAC70\uB9AC(km)</div></div>' +
      '<div class="qs-item"><div class="qs-icon">\u23F1</div><div class="qs-value">' + qs.total_time_hours + '</div><div class="qs-label">\uCD1D \uC2DC\uAC04(h)</div></div>' +
    '</div>';

    // Weekly quests
    var wq = h.weekly_quests;
    var completed = wq.filter(function(q) { return q.completed; }).length;
    html += '<div class="section-title">\u2694\uFE0F \uC774\uBC88 \uC8FC \uD038\uC2A4\uD2B8 <span class="count">' + completed + '/' + wq.length + '</span></div>';
    if (wq.length === 0) {
      html += '<div class="quest-empty">\uD83D\uDCDD /plan \uBA85\uB839\uC5B4\uB85C \uC774\uBC88 \uC8FC \uACC4\uD68D\uC744 \uBA3C\uC800 \uB9CC\uB4E4\uC5B4\uC8FC\uC138\uC694</div>';
    } else {
      html += '<div class="quest-list">';
      wq.forEach(function(q) {
        var pct = q.target_value > 0 ? Math.min(100, (q.current_value / q.target_value) * 100) : 0;
        var cls = q.completed ? ' completed' : '';
        var typeLabel = QUEST_TYPE_LABELS[q.quest_type] || q.quest_type;
        var xp = QUEST_XP[q.quest_type] || 30;
        html += '<div class="quest-card' + cls + '" data-type="' + q.quest_type + '">' +
          '<div class="quest-top"><span class="quest-pill ' + q.quest_type + '">' + esc(typeLabel) + '</span><span class="quest-xp">+' + xp + ' XP</span></div>' +
          '<div class="quest-title">' + esc(q.title) + '</div>' +
          '<div class="quest-progress-bar"><div class="quest-progress-fill" style="width:' + pct + '%"></div></div>' +
          '<div class="quest-progress-text">' + q.current_value + ' / ' + q.target_value + ' ' + esc(q.unit) + '</div>' +
        '</div>';
      });
      html += '</div>';
    }
    return html;
  }

  // -------------------------------------------------------
  // QUEST PATH TAB
  // -------------------------------------------------------
  function renderQuestPath(d) {
    var stages = d.quest_path.stages;
    if (!expandedStage) {
      var cur = stages.find(function(s) { return s.status === 'current'; });
      if (cur) expandedStage = cur.id;
    }

    var html = '<div class="quest-path-title">\uD038\uC2A4\uD2B8 \uACBD\uB85C</div>' +
      '<div class="quest-path-sub">\uB2E8\uACC4\uBCC4 \uBBF8\uC158\uC744 \uD074\uB9AC\uC5B4\uD558\uBA70 \uC131\uC7A5\uD558\uC138\uC694</div>';

    html += '<div class="path-container"><div class="path-line"></div><div class="path-stages">';

    stages.forEach(function(stage) {
      var completedM = stage.missions.filter(function(m) { return m.completed; }).length;
      var totalM = stage.missions.length;
      var isExpanded = expandedStage === stage.id;
      var nodeIcon = stage.status === 'completed' ? '\u2713' : stage.status === 'current' ? '\u26A1' : '\uD83D\uDD12';

      html += '<div class="stage-item ' + stage.status + '">' +
        '<div class="stage-node">' + nodeIcon + '</div>' +
        '<div class="stage-card" data-stage-id="' + stage.id + '">' +
          '<div class="stage-head"><div class="stage-meta"><span class="stage-lv">Lv.' + stage.level + '</span>';
      if (stage.status === 'current') html += '<span class="stage-now-badge">NOW</span>';
      html += '</div><div style="display:flex;align-items:center;gap:6px">';
      if (stage.status !== 'locked') html += '<span class="stage-count">' + completedM + '/' + totalM + '</span>';
      if (stage.status !== 'locked') html += '<span class="stage-chevron' + (isExpanded ? ' open' : '') + '">\u25BC</span>';
      html += '</div></div>' +
          '<div class="stage-title">' + esc(stage.title) + '</div>' +
          '<div class="stage-desc">' + esc(stage.description) + '</div>';

      if (stage.status === 'current') {
        var pct = totalM > 0 ? (completedM / totalM) * 100 : 0;
        html += '<div class="stage-progress-bar"><div class="stage-progress-fill" style="width:' + pct + '%"></div></div>';
      }

      if (isExpanded && stage.status !== 'locked') {
        html += '<div class="stage-missions">';
        stage.missions.forEach(function(m) {
          var cls = m.completed ? 'done' : 'pending';
          html += '<div class="mission-row ' + cls + '">' +
            '<div class="mission-check ' + cls + '">' + (m.completed ? '\u2713' : '') + '</div>' +
            '<span class="mission-name">' + esc(m.name) + '</span>' +
          '</div>';
        });
        html += '</div>';
      }
      html += '</div></div>';
    });

    // Trophy
    html += '<div class="trophy-final">' +
      '<div class="trophy-node">\uD83C\uDFC6</div>' +
      '<div class="trophy-card">' +
        '<div class="trophy-title">\uCD5C\uC885 \uBAA9\uD45C</div>' +
        '<div class="trophy-desc">\uBAA8\uB4E0 \uD038\uC2A4\uD2B8\uB97C \uD074\uB9AC\uC5B4\uD558\uACE0 \uB7EC\uB2DD \uB9C8\uC2A4\uD130\uAC00 \uB418\uC138\uC694!</div>' +
      '</div></div>';

    html += '</div></div>';
    return html;
  }

  // -------------------------------------------------------
  // STATS TAB
  // -------------------------------------------------------
  function renderStats(d) {
    var s = d.stats;

    var html = '<div class="stats-page-title">\uB098\uC758 \uAE30\uB85D</div>' +
      '<div class="stats-page-sub">\uB204\uC801\uB41C \uB7EC\uB2DD \uB370\uC774\uD130\uB97C \uD655\uC778\uD558\uC138\uC694</div>';

    // Period toggle
    html += '<div class="period-toggle">' +
      '<button class="period-btn' + (statsPeriod === 'week' ? ' active' : '') + '" data-period="week">\uC774\uBC88 \uC8FC</button>' +
      '<button class="period-btn' + (statsPeriod === 'month' ? ' active' : '') + '" data-period="month">\uC774\uBC88 \uB2EC</button>' +
      '<button class="period-btn' + (statsPeriod === 'total' ? ' active' : '') + '" data-period="total">\uC804\uCCB4</button>' +
    '</div>';

    // Stats cards
    var distVal, timeVal, runsVal, paceVal;
    if (statsPeriod === 'week') {
      var wDist = s.weekly.reduce(function(a, b) { return a + b.distance; }, 0);
      var wTime = s.weekly.reduce(function(a, b) { return a + b.time; }, 0);
      var wRuns = s.weekly.filter(function(d) { return d.distance > 0; }).length;
      distVal = wDist.toFixed(1);
      timeVal = wTime;
      runsVal = wRuns;
      paceVal = s.totals.avg_pace;
    } else if (statsPeriod === 'month') {
      // current month from monthly data (last item)
      var mData = s.monthly[s.monthly.length - 1];
      distVal = mData ? mData.distance : 0;
      timeVal = '-';
      runsVal = '-';
      paceVal = s.totals.avg_pace;
    } else {
      distVal = s.totals.distance_km;
      timeVal = s.totals.time_min;
      runsVal = s.totals.runs;
      paceVal = s.totals.avg_pace;
    }

    html += '<div class="stats-grid">' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(var(--btn-rgb,38,120,182),0.1)">\uD83D\uDCCD</div><div class="stats-card-value">' + distVal + '</div><div class="stats-card-label">\uCD1D \uAC70\uB9AC (km)</div></div>' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(168,85,247,0.1)">\u23F1</div><div class="stats-card-value">' + (typeof timeVal === 'number' ? fmtMin(timeVal) : timeVal) + '</div><div class="stats-card-label">\uCD1D \uC2DC\uAC04</div></div>' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(239,68,68,0.1)">\uD83D\uDCC5</div><div class="stats-card-value">' + runsVal + '</div><div class="stats-card-label">\uB7EC\uB2DD \uD69F\uC218</div></div>' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(34,197,94,0.1)">\u26A1</div><div class="stats-card-value">' + paceVal + '</div><div class="stats-card-label">\uD3C9\uADE0 \uD398\uC774\uC2A4</div></div>' +
    '</div>';

    // Charts
    if (statsPeriod === 'week') {
      var maxD = Math.max.apply(null, s.weekly.map(function(d) { return d.distance; }));
      html += '<div class="chart-card"><div class="chart-title">\uC8FC\uAC04 \uAC70\uB9AC</div><div class="bar-chart">';
      s.weekly.forEach(function(day) {
        var h = maxD > 0 ? (day.distance / maxD) * 100 : 0;
        var cls = day.distance > 0 ? 'has-data' : 'no-data';
        html += '<div class="bar-col">';
        if (day.distance > 0) html += '<div class="bar-value">' + day.distance + '</div>';
        html += '<div class="bar-fill ' + cls + '" style="height:' + (day.distance > 0 ? Math.max(h, 8) + '%' : '4px') + '"></div>' +
          '<div class="bar-label">' + day.day + '</div></div>';
      });
      html += '</div></div>';
    }

    if (statsPeriod === 'month') {
      var maxM = Math.max.apply(null, s.monthly.map(function(m) { return m.distance; }));
      html += '<div class="chart-card"><div class="chart-title">\uC6D4\uBCC4 \uAC70\uB9AC</div><div class="bar-chart">';
      s.monthly.forEach(function(m) {
        var h = maxM > 0 ? (m.distance / maxM) * 100 : 0;
        var cls = m.distance > 0 ? 'has-data' : 'no-data';
        html += '<div class="bar-col">';
        if (m.distance > 0) html += '<div class="bar-value">' + m.distance + '</div>';
        html += '<div class="bar-fill ' + cls + '" style="height:' + (m.distance > 0 ? Math.max(h, 8) + '%' : '4px') + '"></div>' +
          '<div class="bar-label">' + m.month + '</div></div>';
      });
      html += '</div></div>';
    }

    if (statsPeriod === 'total') {
      var r = s.records;
      html += '<div class="chart-card"><div class="chart-title">\uAC1C\uC778 \uCD5C\uACE0 \uAE30\uB85D</div><div class="records-list">' +
        '<div class="record-row"><div class="record-left"><span class="record-icon">\uD83D\uDCCF</span><span class="record-label">\uCD5C\uC7A5 \uAC70\uB9AC</span></div><span class="record-value">' + r.longest_distance_km + ' km</span></div>' +
        '<div class="record-row"><div class="record-left"><span class="record-icon">\u26A1</span><span class="record-label">\uCD5C\uACE0 \uD398\uC774\uC2A4</span></div><span class="record-value">' + r.best_pace + ' /km</span></div>' +
        '<div class="record-row"><div class="record-left"><span class="record-icon">\u23F1</span><span class="record-label">\uCD5C\uC7A5 \uC2DC\uAC04</span></div><span class="record-value">' + fmtMin(r.longest_time_min) + '</span></div>' +
        '<div class="record-row"><div class="record-left"><span class="record-icon">\uD83D\uDD25</span><span class="record-label">\uCD5C\uC7A5 \uC5F0\uC18D</span></div><span class="record-value">' + r.longest_streak + '\uC8FC</span></div>' +
      '</div></div>';
    }

    return html;
  }

  // -------------------------------------------------------
  // PROFILE TAB
  // -------------------------------------------------------
  function renderProfile(d) {
    var p = d.profile;
    var initial = (p.name || '?').charAt(0).toUpperCase();
    var xpPct = p.next_level_xp > 0 ? Math.min(100, (p.current_xp / p.next_level_xp) * 100) : 100;
    var sinceText = p.joined_date ? formatDate(p.joined_date) + '\uBD80\uD130 \uB7EC\uB2DD' : '';

    var html = '';
    // Header
    html += '<div class="card profile-header-card">' +
      '<div class="profile-top">' +
        '<div class="avatar"><div class="avatar-circle">' + esc(initial) + '</div><div class="avatar-badge">' + p.level + '</div></div>' +
        '<div class="profile-info">' +
          '<div class="profile-name">' + esc(p.name) + '</div>' +
          '<div class="profile-since">' + esc(sinceText) + '</div>' +
          '<div class="profile-xp-row"><div class="profile-xp-bar"><div class="profile-xp-fill" style="width:' + xpPct + '%"></div></div><span class="profile-xp-label">Lv.' + p.level + '</span></div>' +
        '</div>' +
      '</div>' +
      '<div class="profile-stats">' +
        '<div class="ps-item"><div class="ps-value">' + fmtNum(p.total_runs) + '</div><div class="ps-label">\uB7EC\uB2DD</div></div>' +
        '<div class="ps-item"><div class="ps-value">' + fmtNum(Math.round(p.total_distance_km)) + '</div><div class="ps-label">km</div></div>' +
        '<div class="ps-item"><div class="ps-value">' + p.current_streak + '</div><div class="ps-label">\uC5F0\uC18D(\uC8FC)</div></div>' +
        '<div class="ps-item"><div class="ps-value">' + fmtNum(p.total_xp) + '</div><div class="ps-label">XP</div></div>' +
      '</div>' +
    '</div>';

    // Level Roadmap
    html += '<div class="card">' +
      '<div class="roadmap-title">\u2B50 \uB808\uBCA8 \uB85C\uB4DC\uB9F5</div><div class="level-list">';
    for (var i = 0; i < XP_LEVELS.length; i++) {
      var lv = XP_LEVELS[i];
      var isCurrent = lv.level === p.level;
      var isReached = lv.level < p.level;
      var cls = isCurrent ? 'current' : isReached ? 'reached' : 'locked';
      html += '<div class="level-row ' + cls + '">';
      if (isReached || isCurrent) {
        html += '<div class="lv-icon-box">' + lv.level + '</div>';
      } else {
        html += '<div class="lv-icon-box">' + lv.icon + '</div>';
      }
      html += '<div class="lv-info"><div class="lv-title">' + esc(lv.title) + '</div><div class="lv-xp">' + lv.min_xp.toLocaleString() + ' XP</div></div>';
      if (isCurrent) html += '<span class="lv-tag current-tag">\uD604\uC7AC</span>';
      else if (isReached) html += '<span class="lv-tag">\uB2EC\uC131</span>';
      else html += '<span style="font-size:12px;color:var(--hint)">\uD83D\uDD12</span>';
      html += '</div>';
    }
    html += '</div></div>';

    // Milestones
    var achieved = (p.milestones || []).filter(function(m) { return m.achieved; });
    var locked = (p.milestones || []).filter(function(m) { return !m.achieved; });

    if (achieved.length > 0) {
      html += '<div class="card"><div class="milestones-title">\uD83C\uDFC6 \uD68D\uB4DD\uD55C \uBC30\uC9C0 <span class="mcount">' + achieved.length + '/' + p.milestones.length + '</span></div><div class="milestone-grid">';
      achieved.forEach(function(m) {
        html += '<div class="ms-card"><div class="ms-icon">' + m.icon + '</div><div class="ms-title">' + esc(m.title) + '</div><div class="ms-date">' + formatDate(m.achieved_at) + '</div></div>';
      });
      html += '</div></div>';
    }

    if (locked.length > 0) {
      html += '<div class="card"><div class="milestones-title">\uD83D\uDD12 \uBBF8\uD68D\uB4DD \uBC30\uC9C0 <span class="mcount">' + locked.length + '</span></div><div class="milestone-grid">';
      locked.forEach(function(m) {
        var prog = m.progress || {};
        var pct = prog.target ? Math.min(100, (prog.current / prog.target) * 100) : 0;
        html += '<div class="ms-card locked"><div class="ms-lock">\uD83D\uDD12</div><div class="ms-icon">' + m.icon + '</div><div class="ms-title">' + esc(m.title) + '</div>';
        if (prog.target) {
          html += '<div class="ms-prog-bar"><div class="ms-prog-fill" style="width:' + pct + '%"></div></div><div class="ms-prog-text">' + prog.current + ' / ' + prog.target + '</div>';
        }
        html += '</div>';
      });
      html += '</div>';
    }

    // CTA
    html += '<div class="cta-section">' +
      '<a href="' + SURVEY_URL + '" class="btn-primary">\uD504\uB85C\uD544 \uC218\uC815</a>' +
      '<button class="btn-secondary" id="btn-close">\uB2EB\uAE30</button>' +
    '</div>';

    return html;
  }

  // -------------------------------------------------------
  // Render error
  // -------------------------------------------------------
  function renderError(msg) {
    return '<div class="error-container">' +
      '<div class="error-icon">\uD83D\uDE16</div>' +
      '<div class="error-title">\uBB38\uC81C\uAC00 \uBC1C\uC0DD\uD588\uC5B4\uC694</div>' +
      '<div class="error-msg">' + esc(msg) + '</div>' +
      '<button class="error-retry" onclick="location.reload()">\uB2E4\uC2DC \uC2DC\uB3C4</button>' +
    '</div>';
  }

  // -------------------------------------------------------
  // Tab switching
  // -------------------------------------------------------
  function switchTab(tab) {
    activeTab = tab;
    renderActiveTab();

    // Update nav
    document.querySelectorAll('.nav-btn').forEach(function(btn) {
      btn.classList.toggle('active', btn.dataset.tab === tab);
    });

    // Update URL without reload
    var url = new URL(window.location);
    url.searchParams.set('tab', tab);
    history.replaceState(null, '', url);

    // Scroll to top
    window.scrollTo(0, 0);
  }

  function renderActiveTab() {
    if (!appData) return;
    var app = document.getElementById('app');
    var html = '';

    if (activeTab === 'home') html = renderHome(appData);
    else if (activeTab === 'quest') html = renderQuestPath(appData);
    else if (activeTab === 'stats') html = renderStats(appData);
    else if (activeTab === 'profile') html = renderProfile(appData);

    app.innerHTML = '<div class="tab-content active">' + html + '</div>';
    attachTabEvents();
  }

  function attachTabEvents() {
    // Stage expand/collapse
    document.querySelectorAll('.stage-card').forEach(function(card) {
      card.addEventListener('click', function() {
        var id = this.dataset.stageId;
        var stage = appData.quest_path.stages.find(function(s) { return s.id === id; });
        if (stage && stage.status === 'locked') return;
        expandedStage = expandedStage === id ? null : id;
        renderActiveTab();
      });
    });

    // Stats period toggle
    document.querySelectorAll('.period-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        statsPeriod = this.dataset.period;
        renderActiveTab();
      });
    });

    // Profile close button
    var closeBtn = document.getElementById('btn-close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        if (tg) tg.close();
      });
    }
  }

  // -------------------------------------------------------
  // Init
  // -------------------------------------------------------
  async function init() {
    var app = document.getElementById('app');
    try {
      appData = await fetchAppData();
      document.getElementById('bottom-nav').style.display = '';
      renderActiveTab();

      // Attach nav events
      document.querySelectorAll('.nav-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          switchTab(this.dataset.tab);
        });
      });

      // Set initial active nav
      document.querySelectorAll('.nav-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.tab === activeTab);
      });
    } catch (e) {
      app.innerHTML = renderError(e.message || '\uC54C \uC218 \uC5C6\uB294 \uC624\uB958');
    }
  }

  init();
})();
</script>
</body>
</html>
