<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Running Coach</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --hint: var(--tg-theme-hint-color, #999999);
    --link: var(--tg-theme-link-color, #2678b6);
    --btn: var(--tg-theme-button-color, #2678b6);
    --btn-text: var(--tg-theme-button-text-color, #ffffff);
    --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
    --section-bg: var(--tg-theme-section-bg-color, var(--bg));
    --card-radius: 16px;
    --shimmer-color: rgba(128,128,128,0.08);
    --success: #22c55e;
    --core-color: #F59E0B;
    --method-color: #8B5CF6;
    --stretch-color: #EAB308;
    --nav-height: 56px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--secondary-bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
    padding-bottom: calc(var(--nav-height) + env(safe-area-inset-bottom) + 24px);
  }

  .container { max-width: 480px; margin: 0 auto; padding: 0 16px; }
  .tab-content { display: none; padding-top: 12px; padding-bottom: 16px; }
  .tab-content.active { display: block; animation: fadeIn 0.25s ease; }

  /* Inline icon base */
  .ic { display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
  .ic svg { width: 1em; height: 1em; stroke: currentColor; fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
  .ic-sm svg { width: 16px; height: 16px; }
  .ic-md svg { width: 20px; height: 20px; }
  .ic-lg svg { width: 24px; height: 24px; }

  /* Bottom Navigation */
  .bottom-nav {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 50;
    background: var(--bg);
    border-top: 1px solid var(--secondary-bg);
    padding-bottom: calc(env(safe-area-inset-bottom) + 16px);
  }
  .bottom-nav-inner {
    max-width: 480px; margin: 0 auto;
    display: flex; align-items: center; justify-content: space-around;
  }
  .nav-btn {
    flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px;
    padding: 8px 0 6px; border: none; background: transparent; cursor: pointer;
    -webkit-tap-highlight-color: transparent; transition: color 0.15s; color: var(--hint);
  }
  .nav-btn.active { color: var(--btn); }
  .nav-btn svg { width: 22px; height: 22px; }
  .nav-btn.active svg { stroke-width: 2.5; }
  .nav-btn span { font-size: 10px; font-weight: 500; }
  .nav-btn.active span { font-weight: 700; }

  /* Card */
  .card { background: var(--bg); border-radius: var(--card-radius); padding: 16px; margin-bottom: 12px; }

  /* Skeleton */
  .skeleton { display: flex; flex-direction: column; gap: 12px; padding-top: 20px; }
  .sk-block { background: var(--bg); border-radius: var(--card-radius); position: relative; overflow: hidden; }
  .sk-block::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent 0%, var(--shimmer-color) 50%, transparent 100%); animation: shimmer 1.5s infinite; }
  .sk-1 { height: 160px; } .sk-2 { height: 80px; } .sk-3 { height: 200px; } .sk-4 { height: 120px; }

  /* Error */
  .error-container { text-align: center; padding: 60px 20px; }
  .error-ic { color: var(--hint); margin-bottom: 16px; }
  .error-ic svg { width: 48px; height: 48px; }
  .error-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .error-msg { font-size: 14px; color: var(--hint); line-height: 1.5; }
  .error-retry { margin-top: 20px; padding: 10px 24px; border-radius: 8px; border: none; background: var(--btn); color: var(--btn-text); font-size: 14px; font-weight: 600; cursor: pointer; }

  /* ===== HOME TAB ===== */
  .home-header-card { animation: fadeIn 0.4s ease; }
  .home-top { display: flex; align-items: center; gap: 14px; }
  .avatar { position: relative; flex-shrink: 0; }
  .avatar-circle {
    width: 60px; height: 60px; border-radius: 50%;
    background: var(--btn); color: var(--btn-text);
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; font-weight: 700;
  }
  .avatar-badge {
    position: absolute; bottom: -2px; right: -2px;
    width: 22px; height: 22px; border-radius: 50%;
    background: var(--link); color: #fff;
    font-size: 10px; font-weight: 700;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid var(--bg);
  }
  .home-info { flex: 1; min-width: 0; }
  .home-name { font-size: 18px; font-weight: 700; }
  .home-sub { font-size: 12px; color: var(--hint); margin-top: 2px; display: flex; align-items: center; gap: 4px; }
  .home-streak { display: inline-flex; align-items: center; gap: 3px; color: #ef4444; font-weight: 600; }
  .home-streak svg { width: 14px; height: 14px; stroke: #ef4444; }
  .home-xp-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
  .home-xp-bar { flex: 1; height: 8px; background: var(--secondary-bg); border-radius: 4px; overflow: hidden; }
  .home-xp-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, var(--btn), var(--link)); transition: width 0.8s ease; position: relative; overflow: hidden; }
  .home-xp-fill::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: shimmer 2s infinite; }
  .home-xp-label { font-size: 11px; font-weight: 600; color: var(--hint); white-space: nowrap; }
  .home-stats {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 14px;
  }
  .hs-item { display: flex; flex-direction: column; align-items: center; padding: 8px 4px; background: var(--secondary-bg); border-radius: 10px; }
  .hs-value { font-size: 15px; font-weight: 700; }
  .hs-label { font-size: 10px; color: var(--hint); margin-top: 1px; }

  .section-title {
    font-size: 16px; font-weight: 700; margin: 16px 0 10px;
    display: flex; align-items: center; gap: 6px;
  }
  .section-title .ic svg { width: 18px; height: 18px; }
  .section-title .count { font-size: 12px; color: var(--hint); font-weight: 500; margin-left: auto; }

  .quest-list { display: flex; flex-direction: column; gap: 8px; }
  .quest-card { background: var(--bg); border-radius: 12px; padding: 12px 12px 12px 16px; position: relative; overflow: hidden; }
  .quest-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; }
  .quest-card[data-type="core"]::before { background: var(--core-color); }
  .quest-card[data-type="method"]::before { background: var(--method-color); }
  .quest-card[data-type="stretch"]::before { background: var(--stretch-color); }
  .quest-card.completed { background: rgba(34,197,94,0.06); }
  .quest-card.completed .quest-done-ic { position: absolute; right: 12px; top: 12px; color: var(--success); }
  .quest-card.completed .quest-done-ic svg { width: 20px; height: 20px; }
  .quest-top { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; }
  .quest-pill { font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 20px; color: #fff; }
  .quest-pill.core { background: var(--core-color); }
  .quest-pill.method { background: var(--method-color); }
  .quest-pill.stretch { background: var(--stretch-color); }
  .quest-xp { font-size: 10px; font-weight: 600; color: var(--link); margin-left: auto; }
  .quest-title { font-size: 14px; font-weight: 600; margin-bottom: 6px; }
  .quest-progress-bar { height: 6px; background: var(--secondary-bg); border-radius: 3px; overflow: hidden; }
  .quest-progress-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }
  .quest-card[data-type="core"] .quest-progress-fill { background: var(--core-color); }
  .quest-card[data-type="method"] .quest-progress-fill { background: var(--method-color); }
  .quest-card[data-type="stretch"] .quest-progress-fill { background: var(--stretch-color); }
  .quest-card.completed .quest-progress-fill { background: var(--success); }
  .quest-progress-text { font-size: 11px; color: var(--hint); margin-top: 3px; text-align: right; }
  .quest-empty { text-align: center; padding: 24px 16px; color: var(--hint); background: var(--bg); border-radius: var(--card-radius); font-size: 13px; }

  /* Home: Summary Cards */
  .summary-row { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
  .summary-card { flex: 1; background: var(--bg); border-radius: 14px; padding: 14px; border: 1px solid var(--secondary-bg); }
  .summary-card-head { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
  .summary-card-head .sc-icon { color: var(--btn); display: flex; }
  .summary-card-head .sc-icon svg { width: 16px; height: 16px; }
  .summary-card-head .sc-title { font-size: 12px; font-weight: 600; color: var(--hint); }
  .summary-card-head .sc-edit { margin-left: auto; color: var(--link); display: flex; cursor: pointer; }
  .summary-card-head .sc-edit svg { width: 14px; height: 14px; }
  .sc-content { font-size: 13px; line-height: 1.6; }
  .sc-content .sc-row { display: flex; align-items: center; gap: 4px; }
  .sc-content .sc-label { color: var(--hint); font-size: 11px; }
  .sc-content .sc-value { font-weight: 600; }
  .sc-empty { font-size: 12px; color: var(--hint); text-align: center; padding: 4px 0; }
  .sc-empty a { color: var(--link); text-decoration: none; font-weight: 600; }
  .plan-mini { display: flex; gap: 3px; margin-top: 4px; }
  .plan-mini-day { flex: 1; text-align: center; padding: 4px 0; border-radius: 6px; font-size: 10px; }
  .plan-mini-day.rest { background: var(--secondary-bg); color: var(--hint); }
  .plan-mini-day.active { background: rgba(var(--btn-rgb,38,120,182),0.12); color: var(--btn); font-weight: 600; }
  .plan-mini-dist { font-size: 9px; font-weight: 700; }

  /* ===== QUEST PATH TAB ===== */
  .quest-path-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .quest-path-sub { font-size: 13px; color: var(--hint); margin-bottom: 20px; }
  .path-container { position: relative; }
  .path-line { position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: var(--secondary-bg); }
  .path-stages { display: flex; flex-direction: column; gap: 10px; }
  .stage-item { position: relative; }
  .stage-node {
    position: absolute; left: 20px; top: 16px; transform: translateX(-50%); z-index: 2;
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    border: 3px solid var(--secondary-bg); background: var(--bg); color: var(--hint);
  }
  .stage-node svg { width: 14px; height: 14px; }
  .stage-item.completed .stage-node { border-color: var(--btn); background: var(--btn); color: var(--btn-text); }
  .stage-item.current .stage-node { border-color: var(--btn); color: var(--btn); animation: pulse 2s infinite; }
  .stage-card {
    margin-left: 48px; border-radius: 14px; padding: 14px;
    border: 1px solid var(--secondary-bg); background: var(--bg);
    cursor: pointer; -webkit-tap-highlight-color: transparent; transition: all 0.2s;
  }
  .stage-item.completed .stage-card { border-color: rgba(var(--btn-rgb, 38,120,182), 0.15); background: rgba(var(--btn-rgb, 38,120,182), 0.03); }
  .stage-item.current .stage-card { border-color: var(--btn); box-shadow: 0 2px 12px rgba(var(--btn-rgb, 38,120,182), 0.1); }
  .stage-item.locked .stage-card { opacity: 0.5; cursor: default; }
  .stage-head { display: flex; align-items: center; justify-content: space-between; }
  .stage-meta { display: flex; align-items: center; gap: 6px; }
  .stage-lv { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--hint); }
  .stage-item.completed .stage-lv, .stage-item.current .stage-lv { color: var(--btn); }
  .stage-now-badge { font-size: 9px; font-weight: 700; padding: 1px 6px; border-radius: 10px; background: var(--btn); color: var(--btn-text); }
  .stage-count { font-size: 12px; color: var(--hint); }
  .stage-chevron { color: var(--hint); transition: transform 0.2s; display: flex; }
  .stage-chevron svg { width: 16px; height: 16px; }
  .stage-chevron.open { transform: rotate(180deg); }
  .stage-title { font-size: 15px; font-weight: 700; margin-top: 4px; }
  .stage-item.locked .stage-title { color: var(--hint); }
  .stage-desc { font-size: 12px; color: var(--hint); margin-top: 2px; }
  .stage-progress-bar { margin-top: 10px; height: 4px; background: var(--secondary-bg); border-radius: 2px; overflow: hidden; }
  .stage-progress-fill { height: 100%; border-radius: 2px; background: var(--btn); transition: width 0.6s ease; }
  .stage-missions { margin-top: 8px; padding: 10px; background: var(--secondary-bg); border-radius: 10px; display: flex; flex-direction: column; gap: 6px; }
  .mission-row { display: flex; align-items: center; gap: 8px; padding: 4px; }
  .mission-check { width: 18px; height: 18px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
  .mission-check svg { width: 12px; height: 12px; }
  .mission-check.done { background: var(--btn); color: var(--btn-text); }
  .mission-check.pending { border: 2px solid var(--hint); opacity: 0.4; }
  .mission-name { font-size: 13px; }
  .mission-row.done .mission-name { font-weight: 500; }
  .mission-row.pending .mission-name { color: var(--hint); }
  .trophy-final { position: relative; margin-top: 10px; }
  .trophy-node {
    position: absolute; left: 20px; top: 10px; transform: translateX(-50%); z-index: 2;
    width: 36px; height: 36px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    background: var(--secondary-bg); color: var(--btn);
  }
  .trophy-node svg { width: 18px; height: 18px; }
  .trophy-card { margin-left: 48px; border-radius: 14px; padding: 14px; border: 1px solid var(--secondary-bg); background: var(--bg); }
  .trophy-title { font-size: 15px; font-weight: 700; }
  .trophy-desc { font-size: 12px; color: var(--hint); margin-top: 2px; }

  /* ===== STATS TAB ===== */
  .stats-page-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
  .stats-page-sub { font-size: 13px; color: var(--hint); margin-bottom: 16px; }
  .period-toggle { display: flex; border-radius: 12px; background: var(--bg); padding: 3px; margin-bottom: 16px; }
  .period-btn { flex: 1; padding: 8px 0; border: none; border-radius: 10px; background: transparent; font-size: 13px; font-weight: 500; color: var(--hint); cursor: pointer; transition: all 0.2s; -webkit-tap-highlight-color: transparent; }
  .period-btn.active { background: var(--btn); color: var(--btn-text); font-weight: 600; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
  .stats-card { background: var(--bg); border-radius: 14px; padding: 14px; border: 1px solid var(--secondary-bg); }
  .stats-card-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px; }
  .stats-card-icon svg { width: 16px; height: 16px; }
  .stats-card-value { font-size: 22px; font-weight: 700; }
  .stats-card-label { font-size: 11px; color: var(--hint); margin-top: 2px; }
  .chart-card { background: var(--bg); border-radius: var(--card-radius); padding: 16px; margin-bottom: 12px; border: 1px solid var(--secondary-bg); }
  .chart-title { font-size: 15px; font-weight: 600; margin-bottom: 14px; }
  .bar-chart { display: flex; align-items: flex-end; justify-content: space-between; gap: 6px; height: 110px; }
  .bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: flex-end; }
  .bar-value { font-size: 9px; font-weight: 600; color: var(--text); }
  .bar-fill { width: 100%; border-radius: 6px; transition: height 0.6s ease; min-height: 4px; }
  .bar-fill.has-data { background: var(--btn); }
  .bar-fill.no-data { background: var(--secondary-bg); height: 4px !important; }
  .bar-label { font-size: 10px; color: var(--hint); }
  .records-list { display: flex; flex-direction: column; gap: 8px; }
  .record-row { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg); border-radius: 12px; border: 1px solid var(--secondary-bg); }
  .record-left { display: flex; align-items: center; gap: 10px; }
  .record-ic { color: var(--btn); display: flex; }
  .record-ic svg { width: 20px; height: 20px; }
  .record-label { font-size: 14px; }
  .record-value { font-size: 15px; font-weight: 700; }

  /* ===== SETTINGS TAB ===== */
  .settings-title { font-size: 20px; font-weight: 700; margin-bottom: 16px; }
  .settings-links { display: flex; flex-direction: column; gap: 1px; background: var(--secondary-bg); border-radius: var(--card-radius); overflow: hidden; margin-bottom: 16px; }
  .settings-link {
    display: flex; align-items: center; gap: 12px; padding: 14px 16px;
    background: var(--bg); text-decoration: none; color: var(--text);
    cursor: pointer; border: none; font-size: 15px; font-weight: 500;
    -webkit-tap-highlight-color: transparent; text-align: left; width: 100%;
  }
  .settings-link .sl-icon { color: var(--btn); display: flex; }
  .settings-link .sl-icon svg { width: 20px; height: 20px; }
  .settings-link .sl-arrow { margin-left: auto; color: var(--hint); display: flex; }
  .settings-link .sl-arrow svg { width: 16px; height: 16px; }

  .roadmap-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .roadmap-title svg { width: 16px; height: 16px; color: var(--link); }
  .level-list { display: flex; flex-direction: column; gap: 4px; }
  .level-row { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-radius: 10px; transition: background 0.2s; }
  .level-row.reached { background: rgba(var(--btn-rgb, 38,120,182), 0.05); }
  .level-row.current { background: rgba(var(--btn-rgb, 38,120,182), 0.12); border: 1.5px solid var(--btn); }
  .level-row.locked { background: var(--secondary-bg); opacity: 0.5; }
  .lv-icon-box { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; flex-shrink: 0; }
  .level-row.reached .lv-icon-box, .level-row.current .lv-icon-box { background: var(--btn); color: var(--btn-text); }
  .level-row.locked .lv-icon-box { background: var(--secondary-bg); color: var(--hint); }
  .lv-info { flex: 1; min-width: 0; }
  .lv-title { font-size: 13px; font-weight: 600; }
  .lv-xp { font-size: 10px; color: var(--hint); }
  .level-row.locked .lv-title { color: var(--hint); }
  .lv-tag { font-size: 10px; font-weight: 600; color: var(--btn); padding: 1px 7px; border-radius: 8px; background: rgba(var(--btn-rgb, 38,120,182), 0.1); }
  .lv-tag.current-tag { background: var(--btn); color: var(--btn-text); }
  .lv-lock { color: var(--hint); display: flex; }
  .lv-lock svg { width: 14px; height: 14px; }

  .milestones-title { font-size: 15px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
  .milestones-title svg { width: 16px; height: 16px; }
  .milestones-title .mcount { font-size: 12px; font-weight: 400; color: var(--hint); margin-left: 4px; }
  .milestone-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .ms-card { background: var(--bg); border-radius: 12px; padding: 10px 6px; text-align: center; position: relative; border: 1px solid rgba(var(--btn-rgb, 38,120,182), 0.12); }
  .ms-card.locked { opacity: 0.5; border-color: transparent; background: var(--secondary-bg); }
  .ms-icon { display: flex; align-items: center; justify-content: center; margin: 0 auto; }
  .ms-icon svg { width: 28px; height: 28px; }
  .ms-card.locked .ms-icon { opacity: 0.4; }
  .ms-title { font-size: 10px; font-weight: 600; margin-top: 4px; line-height: 1.3; }
  .ms-date { font-size: 9px; color: var(--hint); margin-top: 2px; }
  .ms-lock-ic { position: absolute; top: 4px; right: 4px; color: var(--hint); display: flex; }
  .ms-lock-ic svg { width: 10px; height: 10px; }
  .ms-prog-bar { margin-top: 4px; height: 3px; background: rgba(128,128,128,0.15); border-radius: 2px; overflow: hidden; }
  .ms-prog-fill { height: 100%; background: var(--hint); border-radius: 2px; }
  .ms-prog-text { font-size: 8px; color: var(--hint); margin-top: 1px; }

  .cta-section { display: flex; flex-direction: column; gap: 8px; margin-top: 16px; }
  .btn-secondary {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 12px; border: 1.5px solid var(--hint); border-radius: 12px;
    background: transparent; color: var(--text); font-size: 14px; font-weight: 600;
    cursor: pointer; -webkit-tap-highlight-color: transparent;
  }
  .btn-secondary svg { width: 16px; height: 16px; }

  @keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
</style>
</head>
<body>

<div class="container" id="app">
  <div class="skeleton" id="loading">
    <div class="sk-block sk-1"></div>
    <div class="sk-block sk-2"></div>
    <div class="sk-block sk-3"></div>
    <div class="sk-block sk-4"></div>
  </div>
</div>

<nav class="bottom-nav" id="bottom-nav" style="display:none">
  <div class="bottom-nav-inner">
    <button class="nav-btn active" data-tab="home">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>Ìôà</span>
    </button>
    <button class="nav-btn" data-tab="quest">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" y1="3" x2="9" y2="18"/><line x1="15" y1="6" x2="15" y2="21"/></svg>
      <span>ÌÄòÏä§Ìä∏</span>
    </button>
    <button class="nav-btn" data-tab="stats">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span>Í∏∞Î°ù</span>
    </button>
    <button class="nav-btn" data-tab="settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
      <span>ÏÑ§Ï†ï</span>
    </button>
  </div>
</nav>

<script>
(function() {
  var API_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/rc-onboarding';
  var SURVEY_URL = 'https://michaeldohyun.github.io/rc-webapp/survey.html?from=app';
  var PLAN_URL = 'https://michaeldohyun.github.io/rc-webapp/plan.html?from=app';

  var QUEST_XP = { core: 30, method: 40, stretch: 50 };
  var QUEST_TYPE_LABELS = { core: 'ÌïµÏã¨', method: 'ÌõàÎ†®Î≤ï', stretch: 'ÎèÑÏ†Ñ' };

  var XP_LEVELS = [
    { level: 1,  title: 'Ï≤´ Î∞úÏûêÍµ≠',       min_xp: 0 },
    { level: 2,  title: 'ÏõåÎ∞çÏóÖ Îü¨ÎÑà',     min_xp: 100 },
    { level: 3,  title: 'Î¶¨Îì¨ÏùÑ Ï∞æÎäî Îü¨ÎÑà', min_xp: 300 },
    { level: 4,  title: 'Íæ∏Ï§ÄÌïú Îü¨ÎÑà',     min_xp: 650 },
    { level: 5,  title: 'ÎèÑÏ†ÑÌïòÎäî Îü¨ÎÑà',   min_xp: 1150 },
    { level: 6,  title: 'ÌéòÏù¥Ïä§Î©îÏù¥Ïª§',     min_xp: 1850 },
    { level: 7,  title: 'ÌõàÎ†®Ïùò Îã¨Ïù∏',     min_xp: 2850 },
    { level: 8,  title: 'ÎßàÎùºÌÜ†ÎÑà',         min_xp: 4350 },
    { level: 9,  title: 'Îü¨Îãù ÎßàÏä§ÌÑ∞',     min_xp: 6350 },
    { level: 10, title: 'Ï†ÑÏÑ§Ïùò Îü¨ÎÑà',     min_xp: 9350 },
  ];

  // ---- SVG Icons (Lucide-style) ----
  var I = {
    flame: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/></svg>',
    run: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13" cy="4" r="2"/><path d="M7.5 16l3-5 2.5 2 3-4"/><path d="M5 21l3-7"/><path d="M12.5 13L16 21"/><path d="M10 5l-2 6"/></svg>',
    pin: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 1116 0z"/><circle cx="12" cy="10" r="3"/></svg>',
    clock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
    target: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>',
    trophy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 010-5H6"/><path d="M18 9h1.5a2.5 2.5 0 000-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20 17 22"/><path d="M18 2H6v7a6 6 0 1012 0V2z"/></svg>',
    lock: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>',
    check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>',
    checkCircle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
    zap: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
    star: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>',
    calendar: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
    ruler: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.3 15.3a2.4 2.4 0 010 3.4l-2.6 2.6a2.4 2.4 0 01-3.4 0L2.7 8.7a2.4 2.4 0 010-3.4l2.6-2.6a2.4 2.4 0 013.4 0z"/><path d="M14.5 12.5l2-2"/><path d="M11.5 9.5l2-2"/><path d="M8.5 6.5l2-2"/><path d="M17.5 15.5l2-2"/></svg>',
    edit: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>',
    clipboard: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>',
    chevronDown: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>',
    chevronRight: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>',
    alertTriangle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
    swords: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" y1="19" x2="19" y2="13"/><line x1="16" y1="16" x2="20" y2="20"/><line x1="19" y1="21" x2="21" y2="19"/><polyline points="14.5 6.5 18 3 21 3 21 6 17.5 9.5"/><line x1="5" y1="14" x2="9" y2="18"/><line x1="7" y1="17" x2="4" y2="20"/><line x1="3" y1="19" x2="5" y2="21"/></svg>',
    barChart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>',
    mountain: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3l4 8 5-5 5 15H2L8 3z"/></svg>',
    heart: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 00-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 00-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 000-7.78z"/></svg>',
    x: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',
    user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
    link: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"/></svg>',
  };

  // Milestone category ‚Üí icon key
  var MS_ICONS = { volume: 'barChart', endurance: 'mountain', consistency: 'flame', speed: 'zap', fitness: 'heart' };

  var appData = null;
  var activeTab = 'home';
  var expandedStage = null;
  var statsPeriod = 'week';

  var tg = window.Telegram && window.Telegram.WebApp;
  var initData = '';
  var userId = null;

  if (tg) { tg.ready(); tg.expand(); initData = tg.initData || ''; if (tg.initDataUnsafe && tg.initDataUnsafe.user) userId = tg.initDataUnsafe.user.id; }

  window.sendCommand = function sendCommand(cmd) {
    if (!userId) return;
    // inline keyboard web_appÏóêÏÑúÎäî sendDataÍ∞Ä ÎèôÏûëÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú API ÏßÅÏ†ë Ìò∏Ï∂ú
    var RC_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/running-coach';
    fetch(RC_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ mode: 'webapp_command', command: cmd, telegram_user_id: userId }),
      keepalive: true,
    }).catch(function(e) { console.error('sendCommand error:', e); });
    if (tg && tg.showPopup) {
      tg.showPopup({ message: 'ÎßåÎì§Í≥† ÏûàÏñ¥Ïöî! Ï±ÑÌåÖÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî üèÉ', buttons: [{ type: 'ok' }] }, function() { tg.close(); });
    } else {
      if (tg) tg.close();
    }
  }

  var params = new URLSearchParams(window.location.search);
  var tabParam = params.get('tab');
  if (tabParam === 'profile') tabParam = 'settings'; // backwards compat
  if (tabParam && ['home','quest','stats','settings'].indexOf(tabParam) !== -1) activeTab = tabParam;

  function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
  function formatDate(ds) { if (!ds) return ''; var d = new Date(ds); return d.getFullYear()+'.'+String(d.getMonth()+1).padStart(2,'0')+'.'+String(d.getDate()).padStart(2,'0'); }
  function fmtNum(n) { if (n >= 10000) return (n/10000).toFixed(1)+'Îßå'; if (n >= 1000) return n.toLocaleString(); return String(n); }
  function fmtMin(m) { if (m >= 60) return Math.floor(m/60)+'h '+m%60+'m'; return m+'m'; }
  function icon(name) { return I[name] || ''; }

  async function fetchAppData() {
    if (!userId) throw new Error('ÌÖîÎ†àÍ∑∏Îû®ÏóêÏÑú Ïó¥Ïñ¥Ï£ºÏÑ∏Ïöî');
    var res = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action: 'get_app_data', telegram_user_id: userId, init_data: initData }) });
    if (!res.ok) throw new Error('ÏÑúÎ≤Ñ Ïò§Î•ò (' + res.status + ')');
    var data = await res.json();
    if (!data.success) throw new Error(data.error || 'Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§');
    return data;
  }

  // ---- HOME TAB ----
  function renderHome(d) {
    var h = d.home, p = d.profile;
    var lvl = h.level;
    var xpPct = lvl.next_level_xp > 0 ? Math.min(100, (lvl.current_xp / lvl.next_level_xp) * 100) : 100;
    var initial = (h.name || '?').charAt(0).toUpperCase();

    var html = '<div class="card home-header-card"><div class="home-top">' +
      '<div class="avatar"><div class="avatar-circle">' + esc(initial) + '</div><div class="avatar-badge">' + lvl.xp_level + '</div></div>' +
      '<div class="home-info"><div class="home-name">' + esc(h.name) + '</div>' +
      '<div class="home-sub">Lv.' + lvl.xp_level + ' ' + esc(lvl.title);
    if (h.streak.current_weeks > 0) html += ' <span class="home-streak">' + icon('flame') + ' ' + h.streak.current_weeks + 'Ï£º</span>';
    html += '</div>' +
      '<div class="home-xp-row"><div class="home-xp-bar"><div class="home-xp-fill" style="width:' + xpPct + '%"></div></div><span class="home-xp-label">' + lvl.current_xp + '/' + lvl.next_level_xp + '</span></div>' +
      '</div></div>' +
      '<div class="home-stats">' +
        '<div class="hs-item"><div class="hs-value">' + fmtNum(p.total_runs) + '</div><div class="hs-label">Îü¨Îãù</div></div>' +
        '<div class="hs-item"><div class="hs-value">' + fmtNum(Math.round(p.total_distance_km)) + '</div><div class="hs-label">km</div></div>' +
        '<div class="hs-item"><div class="hs-value">' + p.current_streak + '</div><div class="hs-label">Ïó∞ÏÜç(Ï£º)</div></div>' +
        '<div class="hs-item"><div class="hs-value">' + fmtNum(p.total_xp) + '</div><div class="hs-label">XP</div></div>' +
      '</div></div>';

    // Survey + Plan summary
    var sv = h.survey_summary;
    var wp = h.weekly_plan;
    var PRIORITY_LABELS = { health: 'Í±¥Í∞ï Í¥ÄÎ¶¨', distance: 'Í±∞Î¶¨ ÎäòÎ¶¨Í∏∞', speed: 'ÏÜçÎèÑ Ìñ•ÏÉÅ', habit: 'ÏäµÍ¥Ä ÌòïÏÑ±', race: 'ÎåÄÌöå Ï§ÄÎπÑ' };
    var FREQ_LABELS = { '1-2': 'Ï£º 1~2Ìöå', '3-4': 'Ï£º 3~4Ìöå', '5+': 'Ï£º 5Ìöå Ïù¥ÏÉÅ' };
    var DAY_SHORT = ['Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†','Ïùº'];

    html += '<div class="summary-row">';
    // Profile summary
    html += '<div class="summary-card"><div class="summary-card-head"><span class="sc-icon">' + icon('user') + '</span><span class="sc-title">Îü¨Îãù ÌîÑÎ°úÌïÑ</span><a href="' + SURVEY_URL + '" class="sc-edit">' + icon('edit') + '</a></div>';
    if (sv && (sv.goal_text || sv.weekly_frequency || sv.priority)) {
      html += '<div class="sc-content">';
      if (sv.goal_text) html += '<div class="sc-row"><span class="sc-value">' + esc(sv.goal_text) + '</span></div>';
      if (sv.weekly_frequency || sv.priority) {
        html += '<div class="sc-row">';
        if (sv.weekly_frequency) html += '<span class="sc-label">' + (FREQ_LABELS[sv.weekly_frequency] || sv.weekly_frequency) + '</span>';
        if (sv.weekly_frequency && sv.priority) html += '<span class="sc-label"> ¬∑ </span>';
        if (sv.priority) html += '<span class="sc-label">' + (PRIORITY_LABELS[sv.priority] || sv.priority) + '</span>';
        html += '</div>';
      }
      if (sv.target_date) html += '<div class="sc-row"><span class="sc-label">Î™©ÌëúÏùº ' + esc(sv.target_date) + '</span></div>';
      html += '</div>';
    } else {
      html += '<div class="sc-empty"><a href="' + SURVEY_URL + '">ÌîÑÎ°úÌïÑ ÏÑ§Ï†ïÌïòÍ∏∞</a></div>';
    }
    html += '</div>';

    // Plan summary
    html += '<div class="summary-card"><div class="summary-card-head"><span class="sc-icon">' + icon('clipboard') + '</span><span class="sc-title">Ïù¥Î≤à Ï£º Í≥ÑÌöç</span><a href="' + PLAN_URL + '" class="sc-edit">' + icon('edit') + '</a></div>';
    if (wp && wp.days && wp.days.length > 0) {
      var planRuns = wp.days.filter(function(d){return !d.is_rest;}).length;
      var planKm = wp.days.reduce(function(a,d){return a+(d.distance_km||0);},0);
      html += '<div class="sc-content"><div class="sc-row"><span class="sc-value">' + planRuns + 'Ìöå</span><span class="sc-label"> ¬∑ </span><span class="sc-value">' + (Math.round(planKm*10)/10) + 'km</span></div></div>';
      html += '<div class="plan-mini">';
      wp.days.forEach(function(d,i) {
        var cls = d.is_rest ? 'rest' : 'active';
        html += '<div class="plan-mini-day ' + cls + '">' + (DAY_SHORT[i]||'') + (d.distance_km && !d.is_rest ? '<div class="plan-mini-dist">' + d.distance_km + '</div>' : '') + '</div>';
      });
      html += '</div>';
    } else {
      html += '<div class="sc-empty"><a href="#" onclick="sendCommand(\'/plan\');return false;">Í≥ÑÌöç ÎßåÎì§Í∏∞</a></div>';
    }
    html += '</div></div>';

    // Weekly quests
    var wq = h.weekly_quests;
    var completed = wq.filter(function(q) { return q.completed; }).length;
    html += '<div class="section-title"><span class="ic">' + icon('swords') + '</span> Ïù¥Î≤à Ï£º ÌÄòÏä§Ìä∏ <span class="count">' + completed + '/' + wq.length + '</span></div>';
    if (wq.length === 0) {
      html += '<div class="quest-empty">/plan Î™ÖÎ†πÏñ¥Î°ú Ïù¥Î≤à Ï£º Í≥ÑÌöçÏùÑ Î®ºÏ†Ä ÎßåÎì§Ïñ¥Ï£ºÏÑ∏Ïöî</div>';
    } else {
      html += '<div class="quest-list">';
      wq.forEach(function(q) {
        var pct = q.target_value > 0 ? Math.min(100, (q.current_value / q.target_value) * 100) : 0;
        var cls = q.completed ? ' completed' : '';
        html += '<div class="quest-card' + cls + '" data-type="' + q.quest_type + '">';
        if (q.completed) html += '<div class="quest-done-ic">' + icon('checkCircle') + '</div>';
        html += '<div class="quest-top"><span class="quest-pill ' + q.quest_type + '">' + esc(QUEST_TYPE_LABELS[q.quest_type] || q.quest_type) + '</span><span class="quest-xp">+' + (QUEST_XP[q.quest_type]||30) + ' XP</span></div>' +
          '<div class="quest-title">' + esc(q.title) + '</div>' +
          '<div class="quest-progress-bar"><div class="quest-progress-fill" style="width:' + pct + '%"></div></div>' +
          '<div class="quest-progress-text">' + q.current_value + ' / ' + q.target_value + ' ' + esc(q.unit) + '</div></div>';
      });
      html += '</div>';
    }
    return html;
  }

  // ---- QUEST PATH TAB ----
  function renderQuestPath(d) {
    var stages = d.quest_path.stages;
    if (!expandedStage) { var cur = stages.find(function(s) { return s.status === 'current'; }); if (cur) expandedStage = cur.id; }

    var html = '<div class="quest-path-title">ÌÄòÏä§Ìä∏ Í≤ΩÎ°ú</div><div class="quest-path-sub">Îã®Í≥ÑÎ≥Ñ ÎØ∏ÏÖòÏùÑ ÌÅ¥Î¶¨Ïñ¥ÌïòÎ©∞ ÏÑ±Ïû•ÌïòÏÑ∏Ïöî</div>';
    html += '<div class="path-container"><div class="path-line"></div><div class="path-stages">';

    stages.forEach(function(stage) {
      var cm = stage.missions.filter(function(m) { return m.completed; }).length;
      var tm = stage.missions.length;
      var isExp = expandedStage === stage.id;
      var nodeHtml = stage.status === 'completed' ? icon('check') : stage.status === 'current' ? icon('zap') : icon('lock');

      html += '<div class="stage-item ' + stage.status + '"><div class="stage-node">' + nodeHtml + '</div>' +
        '<div class="stage-card" data-stage-id="' + stage.id + '"><div class="stage-head"><div class="stage-meta"><span class="stage-lv">Lv.' + stage.level + '</span>';
      if (stage.status === 'current') html += '<span class="stage-now-badge">NOW</span>';
      html += '</div><div style="display:flex;align-items:center;gap:6px">';
      if (stage.status !== 'locked') html += '<span class="stage-count">' + cm + '/' + tm + '</span><span class="stage-chevron' + (isExp ? ' open' : '') + '">' + icon('chevronDown') + '</span>';
      html += '</div></div><div class="stage-title">' + esc(stage.title) + '</div><div class="stage-desc">' + esc(stage.description) + '</div>';

      if (stage.status === 'current') { var pct = tm > 0 ? (cm/tm)*100 : 0; html += '<div class="stage-progress-bar"><div class="stage-progress-fill" style="width:' + pct + '%"></div></div>'; }

      if (isExp && stage.status !== 'locked') {
        html += '<div class="stage-missions">';
        stage.missions.forEach(function(m) {
          var cls = m.completed ? 'done' : 'pending';
          html += '<div class="mission-row ' + cls + '"><div class="mission-check ' + cls + '">' + (m.completed ? icon('check') : '') + '</div><span class="mission-name">' + esc(m.name) + '</span></div>';
        });
        html += '</div>';
      }
      html += '</div></div>';
    });

    html += '<div class="trophy-final"><div class="trophy-node">' + icon('trophy') + '</div><div class="trophy-card"><div class="trophy-title">ÏµúÏ¢Ö Î™©Ìëú</div><div class="trophy-desc">Î™®Îì† ÌÄòÏä§Ìä∏Î•º ÌÅ¥Î¶¨Ïñ¥ÌïòÍ≥† Îü¨Îãù ÎßàÏä§ÌÑ∞Í∞Ä ÎêòÏÑ∏Ïöî!</div></div></div>';
    html += '</div></div>';
    return html;
  }

  // ---- STATS TAB ----
  function renderStats(d) {
    var s = d.stats;
    var html = '<div class="stats-page-title">ÎÇòÏùò Í∏∞Î°ù</div><div class="stats-page-sub">ÎàÑÏ†ÅÎêú Îü¨Îãù Îç∞Ïù¥ÌÑ∞Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>';

    html += '<div class="period-toggle">' +
      '<button class="period-btn' + (statsPeriod==='week'?' active':'') + '" data-period="week">Ïù¥Î≤à Ï£º</button>' +
      '<button class="period-btn' + (statsPeriod==='month'?' active':'') + '" data-period="month">Ïù¥Î≤à Îã¨</button>' +
      '<button class="period-btn' + (statsPeriod==='total'?' active':'') + '" data-period="total">Ï†ÑÏ≤¥</button></div>';

    var dv, tv, rv, pv;
    if (statsPeriod === 'week') {
      dv = s.weekly.reduce(function(a,b){return a+b.distance;},0).toFixed(1);
      tv = s.weekly.reduce(function(a,b){return a+b.time;},0);
      rv = s.weekly.filter(function(d){return d.distance>0;}).length;
      pv = s.totals.avg_pace;
    } else if (statsPeriod === 'month') {
      var mD = s.monthly[s.monthly.length-1]; dv = mD ? mD.distance : 0; tv = '-'; rv = '-'; pv = s.totals.avg_pace;
    } else { dv = s.totals.distance_km; tv = s.totals.time_min; rv = s.totals.runs; pv = s.totals.avg_pace; }

    html += '<div class="stats-grid">' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(var(--btn-rgb,38,120,182),0.1);color:var(--btn)">' + icon('pin') + '</div><div class="stats-card-value">' + dv + '</div><div class="stats-card-label">Ï¥ù Í±∞Î¶¨ (km)</div></div>' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(168,85,247,0.1);color:#a855f7">' + icon('clock') + '</div><div class="stats-card-value">' + (typeof tv==='number'?fmtMin(tv):tv) + '</div><div class="stats-card-label">Ï¥ù ÏãúÍ∞Ñ</div></div>' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(239,68,68,0.1);color:#ef4444">' + icon('calendar') + '</div><div class="stats-card-value">' + rv + '</div><div class="stats-card-label">Îü¨Îãù ÌöüÏàò</div></div>' +
      '<div class="stats-card"><div class="stats-card-icon" style="background:rgba(34,197,94,0.1);color:#22c55e">' + icon('zap') + '</div><div class="stats-card-value">' + pv + '</div><div class="stats-card-label">ÌèâÍ∑† ÌéòÏù¥Ïä§</div></div></div>';

    if (statsPeriod === 'week') {
      var mx = Math.max.apply(null, s.weekly.map(function(d){return d.distance;}));
      html += '<div class="chart-card"><div class="chart-title">Ï£ºÍ∞Ñ Í±∞Î¶¨</div><div class="bar-chart">';
      s.weekly.forEach(function(day) { var h = mx>0?(day.distance/mx)*100:0; var cls = day.distance>0?'has-data':'no-data'; html += '<div class="bar-col">'; if (day.distance>0) html += '<div class="bar-value">'+day.distance+'</div>'; html += '<div class="bar-fill '+cls+'" style="height:'+(day.distance>0?Math.max(h,8)+'%':'4px')+'"></div><div class="bar-label">'+day.day+'</div></div>'; });
      html += '</div></div>';
    }
    if (statsPeriod === 'month') {
      var mxM = Math.max.apply(null, s.monthly.map(function(m){return m.distance;}));
      html += '<div class="chart-card"><div class="chart-title">ÏõîÎ≥Ñ Í±∞Î¶¨</div><div class="bar-chart">';
      s.monthly.forEach(function(m) { var h = mxM>0?(m.distance/mxM)*100:0; var cls = m.distance>0?'has-data':'no-data'; html += '<div class="bar-col">'; if (m.distance>0) html += '<div class="bar-value">'+m.distance+'</div>'; html += '<div class="bar-fill '+cls+'" style="height:'+(m.distance>0?Math.max(h,8)+'%':'4px')+'"></div><div class="bar-label">'+m.month+'</div></div>'; });
      html += '</div></div>';
    }
    if (statsPeriod === 'total') {
      var r = s.records;
      html += '<div class="chart-card"><div class="chart-title">Í∞úÏù∏ ÏµúÍ≥† Í∏∞Î°ù</div><div class="records-list">' +
        '<div class="record-row"><div class="record-left"><span class="record-ic">' + icon('ruler') + '</span><span class="record-label">ÏµúÏû• Í±∞Î¶¨</span></div><span class="record-value">' + r.longest_distance_km + ' km</span></div>' +
        '<div class="record-row"><div class="record-left"><span class="record-ic" style="color:#ef4444">' + icon('zap') + '</span><span class="record-label">ÏµúÍ≥† ÌéòÏù¥Ïä§</span></div><span class="record-value">' + r.best_pace + ' /km</span></div>' +
        '<div class="record-row"><div class="record-left"><span class="record-ic" style="color:#a855f7">' + icon('clock') + '</span><span class="record-label">ÏµúÏû• ÏãúÍ∞Ñ</span></div><span class="record-value">' + fmtMin(r.longest_time_min) + '</span></div>' +
        '<div class="record-row"><div class="record-left"><span class="record-ic" style="color:#f59e0b">' + icon('flame') + '</span><span class="record-label">ÏµúÏû• Ïó∞ÏÜç</span></div><span class="record-value">' + r.longest_streak + 'Ï£º</span></div>' +
      '</div></div>';
    }
    return html;
  }

  // ---- SETTINGS TAB ----
  function renderSettings(d) {
    var p = d.profile;
    var html = '<div class="settings-title">ÏÑ§Ï†ï</div>';

    // Setting links
    var hasPlan = !!(d.home.weekly_plan && d.home.weekly_plan.days && d.home.weekly_plan.days.length > 0);
    html += '<div class="settings-links">' +
      '<a href="' + SURVEY_URL + '" class="settings-link"><span class="sl-icon">' + icon('user') + '</span>Îü¨Îãù ÌîÑÎ°úÌïÑ ÏàòÏ†ï<span class="sl-arrow">' + icon('chevronRight') + '</span></a>';
    if (hasPlan) {
      html += '<a href="' + PLAN_URL + '" class="settings-link"><span class="sl-icon">' + icon('clipboard') + '</span>Ï£ºÍ∞Ñ ÌõàÎ†® Í≥ÑÌöç ÏàòÏ†ï<span class="sl-arrow">' + icon('chevronRight') + '</span></a>';
    } else {
      html += '<button class="settings-link" id="btn-create-plan"><span class="sl-icon">' + icon('clipboard') + '</span>Ï£ºÍ∞Ñ Í≥ÑÌöç ÏÑ∏Ïö∞Í∏∞<span class="sl-arrow" style="font-size:11px;color:var(--hint)">Ï±ÑÌåÖÏóêÏÑú /plan</span></button>';
    }
    html += '</div>';

    // intervals.icu Ïó∞Îèô
    var iv = d.intervals || {};
    html += '<div class="card"><div class="roadmap-title">' + icon('link') + ' intervals.icu Ïó∞Îèô</div>';
    html += '<div style="display:flex;align-items:center;gap:10px;padding:4px 0">';
    if (iv.connected) {
      html += '<span class="ic" style="color:var(--success)">' + icon('checkCircle') + '</span>';
      html += '<div><div style="font-size:14px;font-weight:600">Ïó∞ÎèôÎê®</div>';
      if (iv.api_key_masked) html += '<div style="font-size:12px;color:var(--hint)">API Key: ' + esc(iv.api_key_masked) + '</div>';
      html += '</div>';
    } else {
      html += '<span class="ic" style="color:var(--hint)">' + icon('x') + '</span>';
      html += '<div style="font-size:14px;color:var(--hint)">ÎØ∏Ïó∞Îèô</div>';
    }
    html += '</div></div>';

    // Level Roadmap
    html += '<div class="card"><div class="roadmap-title">' + icon('star') + ' Î†àÎ≤® Î°úÎìúÎßµ</div><div class="level-list">';
    for (var i = 0; i < XP_LEVELS.length; i++) {
      var lv = XP_LEVELS[i];
      var isCur = lv.level === p.level, isR = lv.level < p.level;
      var cls = isCur ? 'current' : isR ? 'reached' : 'locked';
      html += '<div class="level-row ' + cls + '"><div class="lv-icon-box">' + lv.level + '</div>' +
        '<div class="lv-info"><div class="lv-title">' + esc(lv.title) + '</div><div class="lv-xp">' + lv.min_xp.toLocaleString() + ' XP</div></div>';
      if (isCur) html += '<span class="lv-tag current-tag">ÌòÑÏû¨</span>';
      else if (isR) html += '<span class="lv-tag">Îã¨ÏÑ±</span>';
      else html += '<span class="lv-lock">' + icon('lock') + '</span>';
      html += '</div>';
    }
    html += '</div></div>';

    // Milestones
    var achieved = (p.milestones||[]).filter(function(m){return m.achieved;});
    var locked = (p.milestones||[]).filter(function(m){return !m.achieved;});

    if (achieved.length > 0) {
      html += '<div class="card"><div class="milestones-title">' + icon('trophy') + ' ÌöçÎìùÌïú Î∞∞ÏßÄ <span class="mcount">' + achieved.length + '/' + p.milestones.length + '</span></div><div class="milestone-grid">';
      achieved.forEach(function(m) { html += '<div class="ms-card"><div class="ms-icon" style="color:var(--btn)">' + icon(MS_ICONS[m.category] || 'target') + '</div><div class="ms-title">' + esc(m.title) + '</div><div class="ms-date">' + formatDate(m.achieved_at) + '</div></div>'; });
      html += '</div></div>';
    }
    if (locked.length > 0) {
      html += '<div class="card"><div class="milestones-title">' + icon('lock') + ' ÎØ∏ÌöçÎìù Î∞∞ÏßÄ <span class="mcount">' + locked.length + '</span></div><div class="milestone-grid">';
      locked.forEach(function(m) {
        var prog = m.progress || {};
        var pct = prog.target ? Math.min(100, (prog.current/prog.target)*100) : 0;
        html += '<div class="ms-card locked"><div class="ms-lock-ic">' + icon('lock') + '</div><div class="ms-icon">' + icon(MS_ICONS[m.category] || 'target') + '</div><div class="ms-title">' + esc(m.title) + '</div>';
        if (prog.target) html += '<div class="ms-prog-bar"><div class="ms-prog-fill" style="width:' + pct + '%"></div></div><div class="ms-prog-text">' + prog.current + ' / ' + prog.target + '</div>';
        html += '</div>';
      });
      html += '</div>';
    }

    html += '<div class="cta-section"><button class="btn-secondary" id="btn-close">' + icon('x') + ' Îã´Í∏∞</button></div>';
    return html;
  }

  function renderError(msg) {
    return '<div class="error-container"><div class="error-ic">' + icon('alertTriangle') + '</div><div class="error-title">Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏñ¥Ïöî</div><div class="error-msg">' + esc(msg) + '</div><button class="error-retry" onclick="location.reload()">Îã§Ïãú ÏãúÎèÑ</button></div>';
  }

  function switchTab(tab) {
    activeTab = tab;
    renderActiveTab();
    document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === tab); });
    var url = new URL(window.location); url.searchParams.set('tab', tab); history.replaceState(null, '', url);
    window.scrollTo(0, 0);
  }

  function renderActiveTab() {
    if (!appData) return;
    var app = document.getElementById('app');
    var html = '';
    if (activeTab === 'home') html = renderHome(appData);
    else if (activeTab === 'quest') html = renderQuestPath(appData);
    else if (activeTab === 'stats') html = renderStats(appData);
    else if (activeTab === 'settings') html = renderSettings(appData);
    app.innerHTML = '<div class="tab-content active">' + html + '</div>';
    attachTabEvents();
  }

  function attachTabEvents() {
    document.querySelectorAll('.stage-card').forEach(function(c) { c.addEventListener('click', function() { var id = this.dataset.stageId; var st = appData.quest_path.stages.find(function(s){return s.id===id;}); if (st && st.status === 'locked') return; expandedStage = expandedStage===id?null:id; renderActiveTab(); }); });
    document.querySelectorAll('.period-btn').forEach(function(b) { b.addEventListener('click', function() { statsPeriod = this.dataset.period; renderActiveTab(); }); });
    var cb = document.getElementById('btn-close'); if (cb) cb.addEventListener('click', function() { if (tg) tg.close(); });
    var cpb = document.getElementById('btn-create-plan'); if (cpb) cpb.addEventListener('click', function() { sendCommand('/plan'); });
  }

  async function init() {
    var app = document.getElementById('app');
    try {
      appData = await fetchAppData();
      document.getElementById('bottom-nav').style.display = '';
      renderActiveTab();
      document.querySelectorAll('.nav-btn').forEach(function(b) { b.addEventListener('click', function() { switchTab(this.dataset.tab); }); b.classList.toggle('active', b.dataset.tab === activeTab); });
    } catch (e) { app.innerHTML = renderError(e.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'); }
  }

  init();
})();
</script>
</body>
</html>
