<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Running Coach Admin</title>
<style>
:root {
  --bg: #f5f5f5; --card: #fff; --text: #1a1a1a; --sub: #666;
  --border: #e0e0e0; --accent: #2563eb; --bar: #3b82f6;
  --green: #22c55e; --yellow: #eab308; --red: #ef4444;
  --skeleton: #e5e5e5; --skeleton-shine: #f0f0f0;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f0f0f; --card: #1a1a1a; --text: #e5e5e5; --sub: #999;
    --border: #333; --accent: #60a5fa; --bar: #3b82f6;
    --green: #4ade80; --yellow: #facc15; --red: #f87171;
    --skeleton: #2a2a2a; --skeleton-shine: #333;
  }
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); max-width: 480px; margin: 0 auto; min-height: 100vh; }
.view { display: none; }
.view.active { display: block; }

/* Header */
.header { padding: 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); background: var(--card); position: sticky; top: 0; z-index: 10; }
.header h1 { font-size: 18px; flex: 1; }
.back-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--text); padding: 4px 8px; }

/* Auth */
.auth-box { padding: 24px 16px; text-align: center; }
.auth-box h2 { font-size: 16px; margin-bottom: 16px; }
.auth-box input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; background: var(--card); color: var(--text); margin-bottom: 12px; }
.auth-box button { width: 100%; padding: 12px; background: var(--accent); color: #fff; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
.auth-error { color: var(--red); font-size: 14px; margin-top: 8px; }

/* Cards */
.card { background: var(--card); margin: 8px 12px; padding: 14px 16px; border-radius: 12px; border: 1px solid var(--border); }
.card-title { font-size: 13px; color: var(--sub); margin-bottom: 8px; font-weight: 600; }

/* User list */
.user-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.15s; }
.user-item:active { background: var(--border); }
.user-icon { font-size: 28px; width: 40px; text-align: center; }
.user-info { flex: 1; }
.user-name { font-size: 15px; font-weight: 600; }
.user-meta { font-size: 12px; color: var(--sub); margin-top: 2px; }
.user-arrow { color: var(--sub); font-size: 18px; }
.user-count { padding: 12px 16px; font-size: 13px; color: var(--sub); }

/* XP bar */
.xp-bar-wrap { margin: 8px 0; }
.xp-bar-bg { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
.xp-bar-fill { height: 100%; background: var(--accent); border-radius: 4px; transition: width 0.4s ease; }
.xp-label { font-size: 12px; color: var(--sub); margin-top: 4px; text-align: right; }

/* User detail header */
.detail-header { padding: 16px; text-align: center; }
.detail-name { font-size: 20px; font-weight: 700; }
.detail-level { font-size: 14px; color: var(--sub); margin-top: 4px; }
.detail-streak { font-size: 13px; color: var(--accent); margin-top: 6px; }

/* Today plan */
.plan-title { font-size: 16px; font-weight: 600; }
.plan-detail { font-size: 13px; color: var(--sub); margin-top: 4px; }

/* Week summary */
.week-progress { margin: 8px 0; }
.progress-bg { height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; }
.progress-fill { height: 100%; background: var(--green); border-radius: 5px; transition: width 0.4s ease; }
.progress-label { font-size: 13px; margin-top: 4px; }
.week-stats { font-size: 13px; color: var(--sub); margin-top: 6px; }

/* Bar chart */
.bar-chart { display: flex; align-items: flex-end; gap: 4px; height: 80px; margin: 8px 0; }
.bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; }
.bar { width: 100%; background: var(--bar); border-radius: 3px 3px 0 0; min-height: 2px; transition: height 0.3s ease; }
.bar-label { font-size: 10px; color: var(--sub); margin-top: 4px; white-space: nowrap; }
.bar-value { font-size: 10px; color: var(--sub); margin-bottom: 2px; }

/* Fitness */
.fitness-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 8px; }
.fitness-item { text-align: center; padding: 8px; background: var(--bg); border-radius: 8px; }
.fitness-value { font-size: 18px; font-weight: 700; }
.fitness-label { font-size: 11px; color: var(--sub); margin-top: 2px; }
.tsb-fresh { color: var(--green); }
.tsb-neutral { color: var(--yellow); }
.tsb-fatigued { color: var(--red); }

/* Recent runs */
.run-item { padding: 10px 0; border-bottom: 1px solid var(--border); }
.run-item:last-child { border-bottom: none; }
.run-top { display: flex; justify-content: space-between; align-items: center; }
.run-name { font-size: 14px; font-weight: 600; }
.run-date { font-size: 12px; color: var(--sub); }
.run-stats { font-size: 12px; color: var(--sub); margin-top: 4px; }

/* Empty state */
.empty { text-align: center; padding: 24px; color: var(--sub); font-size: 14px; }

/* Skeleton */
.skeleton { background: linear-gradient(90deg, var(--skeleton) 25%, var(--skeleton-shine) 50%, var(--skeleton) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
@keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
.sk-line { height: 14px; margin: 8px 0; }
.sk-bar { height: 80px; margin: 12px 0; }
.sk-card { height: 60px; margin: 8px 12px; border-radius: 12px; }

/* Logout */
.logout-btn { display: block; margin: 16px auto 32px; padding: 10px 24px; background: none; border: 1px solid var(--border); border-radius: 8px; color: var(--sub); font-size: 13px; cursor: pointer; }
</style>
</head>
<body>

<!-- Auth View -->
<div id="authView" class="view">
  <div class="header"><h1>ğŸƒ Running Coach Admin</h1></div>
  <div class="auth-box">
    <h2>ê´€ë¦¬ì ì¸ì¦</h2>
    <input type="password" id="adminKeyInput" placeholder="Admin Key ì…ë ¥" autocomplete="off">
    <button onclick="submitAdminKey()">í™•ì¸</button>
    <div id="authError" class="auth-error"></div>
  </div>
</div>

<!-- User List View -->
<div id="listView" class="view">
  <div class="header">
    <h1>ğŸƒ Running Coach Admin</h1>
    <button class="logout-btn" style="margin:0;padding:4px 12px;font-size:12px" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>
  <div id="userCount" class="user-count"></div>
  <div id="userList"></div>
  <div id="listLoading">
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
    <div class="skeleton sk-card"></div>
  </div>
</div>

<!-- Detail View -->
<div id="detailView" class="view">
  <div class="header">
    <button class="back-btn" onclick="showList()">â†</button>
    <h1 id="detailTitle">ìœ ì €</h1>
  </div>
  <div id="detailContent"></div>
  <div id="detailLoading" style="padding:12px">
    <div class="skeleton sk-line" style="width:60%"></div>
    <div class="skeleton sk-line" style="width:40%"></div>
    <div class="skeleton sk-bar"></div>
    <div class="skeleton sk-line" style="width:80%"></div>
    <div class="skeleton sk-bar"></div>
  </div>
</div>

<script>
const API_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/rc-onboarding';
let adminKey = localStorage.getItem('rc_admin_key') || '';
let usersCache = [];

function init() {
  if (adminKey) {
    showList();
    loadUsers();
  } else {
    show('authView');
  }
}

function show(id) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

async function submitAdminKey() {
  const input = document.getElementById('adminKeyInput');
  const err = document.getElementById('authError');
  adminKey = input.value.trim();
  if (!adminKey) { err.textContent = 'Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'; return; }
  err.textContent = '';
  try {
    const res = await apiCall('get_dashboard_users');
    if (res.success) {
      localStorage.setItem('rc_admin_key', adminKey);
      usersCache = res.users;
      showList();
      renderUsers(res.users);
    } else {
      err.textContent = res.error || 'ì¸ì¦ ì‹¤íŒ¨';
      adminKey = '';
    }
  } catch (e) {
    err.textContent = 'ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
    adminKey = '';
  }
}

function logout() {
  adminKey = '';
  localStorage.removeItem('rc_admin_key');
  show('authView');
}

async function apiCall(action, extra = {}) {
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action, admin_key: adminKey, ...extra }),
  });
  return res.json();
}

async function loadUsers() {
  show('listView');
  document.getElementById('userList').innerHTML = '';
  document.getElementById('listLoading').style.display = 'block';
  document.getElementById('userCount').textContent = '';
  try {
    const res = await apiCall('get_dashboard_users');
    if (res.error === 'ì¸ì¦ ì‹¤íŒ¨') { logout(); return; }
    usersCache = res.users || [];
    renderUsers(usersCache);
  } catch (e) {
    document.getElementById('userList').innerHTML = '<div class="empty">ë¡œë”© ì‹¤íŒ¨</div>';
  }
  document.getElementById('listLoading').style.display = 'none';
}

function renderUsers(users) {
  document.getElementById('listLoading').style.display = 'none';
  const active = users.filter(u => u.onboarding_completed);
  document.getElementById('userCount').textContent = `ğŸ“‹ ${active.length}ëª… í™œì„± / ì´ ${users.length}ëª…`;
  const html = users.map(u => `
    <div class="user-item" onclick="openUser('${u.id}')">
      <div class="user-icon">${u.level_icon}</div>
      <div class="user-info">
        <div class="user-name">${esc(u.first_name)}  Lv.${u.level}</div>
        <div class="user-meta">ğŸ”¥${u.current_streak_weeks}ì£¼${u.last_activity_at ? ' Â· ìµœê·¼ ' + u.last_activity_at.slice(5) : ''}${!u.onboarding_completed ? ' Â· ë¯¸ì™„ë£Œ' : ''}</div>
      </div>
      <div class="user-arrow">â€º</div>
    </div>
  `).join('');
  document.getElementById('userList').innerHTML = html;
}

async function openUser(userId) {
  show('detailView');
  const user = usersCache.find(u => u.id === userId);
  document.getElementById('detailTitle').textContent = user ? user.first_name : 'ìœ ì €';
  document.getElementById('detailContent').innerHTML = '';
  document.getElementById('detailLoading').style.display = 'block';

  try {
    const res = await apiCall('get_dashboard', { user_id: userId });
    if (res.error) {
      document.getElementById('detailContent').innerHTML = `<div class="empty">${esc(res.error)}</div>`;
      document.getElementById('detailLoading').style.display = 'none';
      return;
    }
    renderDetail(res.dashboard);
  } catch (e) {
    document.getElementById('detailContent').innerHTML = '<div class="empty">ë¡œë”© ì‹¤íŒ¨</div>';
  }
  document.getElementById('detailLoading').style.display = 'none';
}

function showList() {
  show('listView');
  if (usersCache.length === 0) loadUsers();
}

function renderDetail(d) {
  const u = d.user;
  const lvl = u.level;
  const xpPct = lvl.next_level_xp > 0 ? Math.min(100, Math.round(lvl.current_xp / lvl.next_level_xp * 100)) : 100;

  let html = '';

  // User header
  html += `<div class="detail-header">
    <div class="detail-name">${lvl.icon} ${esc(u.name)}</div>
    <div class="detail-level">Lv.${lvl.level} ${esc(lvl.title)}</div>
    <div class="xp-bar-wrap">
      <div class="xp-bar-bg"><div class="xp-bar-fill" style="width:${xpPct}%"></div></div>
      <div class="xp-label">${lvl.current_xp} / ${lvl.next_level_xp} XP</div>
    </div>
    <div class="detail-streak">ğŸ”¥ ${u.streak.current_weeks}ì£¼ ì—°ì†</div>
  </div>`;

  // Today plan
  if (d.today_plan) {
    const tp = d.today_plan;
    html += `<div class="card">
      <div class="card-title">ğŸ“‹ ì˜¤ëŠ˜ ê³„íš</div>
      <div class="plan-title">${esc(tp.title)}${tp.distance_km ? ' ' + tp.distance_km + 'km' : ''}</div>
      <div class="plan-detail">${[tp.target_pace ? 'ëª©í‘œ: ' + tp.target_pace : '', tp.target_hr_zone || '', tp.notes || ''].filter(Boolean).join(' Â· ')}</div>
    </div>`;
  } else {
    html += `<div class="card"><div class="card-title">ğŸ“‹ ì˜¤ëŠ˜ ê³„íš</div><div class="empty">ì˜¤ëŠ˜ì€ ê³„íš ì—†ìŒ (íœ´ì‹ì¼)</div></div>`;
  }

  // This week
  const tw = d.this_week;
  const twPct = tw.plan_total_km > 0 ? Math.min(100, Math.round(tw.distance_km / tw.plan_total_km * 100)) : 0;
  html += `<div class="card">
    <div class="card-title">ğŸ“Š ì´ë²ˆ ì£¼</div>
    <div class="week-progress">
      <div class="progress-bg"><div class="progress-fill" style="width:${twPct}%"></div></div>
      <div class="progress-label">${tw.distance_km}${tw.plan_total_km > 0 ? ' / ' + tw.plan_total_km : ''} km</div>
    </div>
    <div class="week-stats">${tw.sessions}íšŒ Â· ${tw.time_min}ë¶„ Â· ${tw.avg_pace}${tw.avg_hr ? ' Â· HR ' + tw.avg_hr : ''}</div>
  </div>`;

  // Weekly volumes (8 weeks)
  const vols = d.weekly_volumes || [];
  if (vols.length > 0) {
    const maxVol = Math.max(...vols.map(v => v.distance_km), 1);
    html += `<div class="card">
      <div class="card-title">ğŸ“ˆ ì£¼ê°„ ë³¼ë¥¨ (8ì£¼)</div>
      <div class="bar-chart">
        ${vols.map(v => {
          const h = Math.max(2, Math.round(v.distance_km / maxVol * 70));
          return `<div class="bar-col">
            <div class="bar-value">${v.distance_km > 0 ? v.distance_km : ''}</div>
            <div class="bar" style="height:${h}px"></div>
            <div class="bar-label">${v.label}</div>
          </div>`;
        }).join('')}
      </div>
    </div>`;
  }

  // Fitness
  if (d.fitness) {
    const f = d.fitness;
    const tsbClass = f.stage === 'fresh' ? 'tsb-fresh' : f.stage === 'fatigued' ? 'tsb-fatigued' : 'tsb-neutral';
    const tsbEmoji = f.stage === 'fresh' ? 'ğŸŸ¢' : f.stage === 'fatigued' ? 'ğŸ”´' : 'ğŸŸ¡';
    html += `<div class="card">
      <div class="card-title">ğŸ’ª í”¼íŠ¸ë‹ˆìŠ¤</div>
      <div class="fitness-grid">
        <div class="fitness-item"><div class="fitness-value">${f.ctl}</div><div class="fitness-label">CTL</div></div>
        <div class="fitness-item"><div class="fitness-value">${f.atl}</div><div class="fitness-label">ATL</div></div>
        <div class="fitness-item"><div class="fitness-value ${tsbClass}">${tsbEmoji} ${f.tsb}</div><div class="fitness-label">TSB</div></div>
      </div>
    </div>`;
  }

  // Recent runs
  if (d.recent_runs && d.recent_runs.length > 0) {
    html += `<div class="card"><div class="card-title">ğŸƒ ìµœê·¼ ëŸ¬ë‹</div>`;
    for (const r of d.recent_runs) {
      html += `<div class="run-item">
        <div class="run-top">
          <div class="run-name">${esc(r.name)}</div>
          <div class="run-date">${r.date.slice(5)}</div>
        </div>
        <div class="run-stats">${r.distance_km}km Â· ${r.duration_min}ë¶„ Â· ${r.avg_pace}${r.avg_hr ? ' Â· HR ' + r.avg_hr : ''}</div>
      </div>`;
    }
    html += '</div>';
  } else {
    html += `<div class="card"><div class="card-title">ğŸƒ ìµœê·¼ ëŸ¬ë‹</div><div class="empty">ëŸ¬ë‹ ê¸°ë¡ ì—†ìŒ</div></div>`;
  }

  html += '<div style="height:32px"></div>';
  document.getElementById('detailContent').innerHTML = html;
}

function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

init();
</script>
</body>
</html>
