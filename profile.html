<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>My Profile</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --hint: var(--tg-theme-hint-color, #999999);
    --link: var(--tg-theme-link-color, #2678b6);
    --btn: var(--tg-theme-button-color, #2678b6);
    --btn-text: var(--tg-theme-button-text-color, #ffffff);
    --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
    --section-bg: var(--tg-theme-section-bg-color, var(--bg));
    --card-radius: 16px;
    --shimmer-color: rgba(128,128,128,0.08);
    --success: #22c55e;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--secondary-bg);
    color: var(--text);
    padding: 0 16px env(safe-area-inset-bottom) 16px;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  .container { max-width: 480px; margin: 0 auto; padding-bottom: 32px; }

  /* Loading skeleton */
  .skeleton { display: flex; flex-direction: column; gap: 16px; padding-top: 20px; }
  .skeleton-block {
    background: var(--bg);
    border-radius: var(--card-radius);
    position: relative;
    overflow: hidden;
  }
  .skeleton-block::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent 0%, var(--shimmer-color) 50%, transparent 100%);
    animation: shimmer 1.5s infinite;
  }
  .sk-header { height: 200px; }
  .sk-roadmap { height: 300px; }
  .sk-badges { height: 160px; }

  /* Card base */
  .card {
    background: var(--bg);
    border-radius: var(--card-radius);
    padding: 20px;
    margin-top: 12px;
  }

  /* Profile Header */
  .profile-header {
    padding: 24px 20px 20px;
    margin-top: 12px;
    animation: fadeIn 0.4s ease;
  }
  .profile-top {
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .avatar {
    position: relative;
    flex-shrink: 0;
  }
  .avatar-circle {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--btn);
    color: var(--btn-text);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 700;
  }
  .avatar-badge {
    position: absolute;
    bottom: -2px;
    right: -2px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--link);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--bg);
  }
  .profile-info { flex: 1; min-width: 0; }
  .profile-name {
    font-size: 18px;
    font-weight: 700;
    line-height: 1.3;
  }
  .profile-since {
    font-size: 12px;
    color: var(--hint);
    margin-top: 2px;
  }
  .xp-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
  }
  .xp-bar {
    flex: 1;
    height: 8px;
    background: var(--secondary-bg);
    border-radius: 4px;
    overflow: hidden;
  }
  .xp-fill {
    height: 100%;
    border-radius: 4px;
    background: linear-gradient(90deg, var(--btn), var(--link));
    transition: width 0.8s ease;
    position: relative;
    overflow: hidden;
  }
  .xp-fill::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    animation: shimmer 2s infinite;
  }
  .xp-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--hint);
    white-space: nowrap;
  }

  /* Stats grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-top: 16px;
  }
  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px 4px;
    background: var(--secondary-bg);
    border-radius: 12px;
  }
  .stat-value {
    font-size: 16px;
    font-weight: 700;
  }
  .stat-label {
    font-size: 10px;
    color: var(--hint);
    margin-top: 2px;
  }

  /* Section title */
  .section-title {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* Level Roadmap */
  .roadmap { animation: fadeInUp 0.4s ease 0.1s both; }
  .level-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .level-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 12px;
    transition: background 0.2s;
  }
  .level-row.reached { background: rgba(var(--btn-rgb, 38,120,182), 0.06); }
  .level-row.current {
    background: rgba(var(--btn-rgb, 38,120,182), 0.12);
    border: 1.5px solid var(--btn);
  }
  .level-row.locked { background: var(--secondary-bg); opacity: 0.55; }
  .level-icon-box {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }
  .level-row.reached .level-icon-box,
  .level-row.current .level-icon-box {
    background: var(--btn);
    color: var(--btn-text);
    font-size: 12px;
    font-weight: 700;
  }
  .level-row.locked .level-icon-box {
    background: var(--secondary-bg);
    font-size: 14px;
  }
  .level-info { flex: 1; min-width: 0; }
  .level-title {
    font-size: 13px;
    font-weight: 600;
  }
  .level-xp {
    font-size: 11px;
    color: var(--hint);
  }
  .level-row.locked .level-title { color: var(--hint); }
  .level-tag {
    font-size: 11px;
    font-weight: 600;
    color: var(--btn);
    padding: 2px 8px;
    border-radius: 10px;
    background: rgba(var(--btn-rgb, 38,120,182), 0.1);
    white-space: nowrap;
  }
  .level-tag.current-tag {
    background: var(--btn);
    color: var(--btn-text);
  }
  .level-lock {
    font-size: 14px;
    color: var(--hint);
  }

  /* Milestones */
  .milestones-section { animation: fadeInUp 0.4s ease 0.2s both; }
  .milestone-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .milestone-card {
    background: var(--bg);
    border-radius: 14px;
    padding: 12px 8px;
    text-align: center;
    border: 1px solid rgba(var(--btn-rgb, 38,120,182), 0.15);
  }
  .milestone-card.locked {
    opacity: 0.55;
    border-color: transparent;
    background: var(--secondary-bg);
  }
  .milestone-icon { font-size: 28px; line-height: 1; }
  .milestone-card.locked .milestone-icon { filter: grayscale(1); }
  .milestone-title {
    font-size: 11px;
    font-weight: 600;
    margin-top: 6px;
    line-height: 1.3;
  }
  .milestone-date {
    font-size: 10px;
    color: var(--hint);
    margin-top: 3px;
  }
  .milestone-lock-icon {
    font-size: 10px;
    position: absolute;
    top: 6px;
    right: 6px;
  }
  .milestone-card { position: relative; }
  .milestone-prog-bar {
    margin-top: 6px;
    height: 4px;
    background: rgba(128,128,128,0.15);
    border-radius: 2px;
    overflow: hidden;
  }
  .milestone-prog-fill {
    height: 100%;
    background: var(--hint);
    border-radius: 2px;
  }
  .milestone-prog-text {
    font-size: 9px;
    color: var(--hint);
    margin-top: 2px;
  }
  .badge-count {
    font-size: 13px;
    font-weight: 400;
    color: var(--hint);
  }

  /* CTA */
  .cta-section {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    animation: fadeInUp 0.4s ease 0.3s both;
  }
  .btn-primary {
    display: block;
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 12px;
    background: var(--btn);
    color: var(--btn-text);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    -webkit-tap-highlight-color: transparent;
  }
  .btn-secondary {
    display: block;
    width: 100%;
    padding: 14px;
    border: 1.5px solid var(--hint);
    border-radius: 12px;
    background: transparent;
    color: var(--text);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    -webkit-tap-highlight-color: transparent;
  }

  /* Error */
  .error-container {
    text-align: center;
    padding: 60px 20px;
  }
  .error-icon { font-size: 48px; margin-bottom: 16px; }
  .error-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .error-msg { font-size: 14px; color: var(--hint); line-height: 1.5; }
  .error-retry {
    margin-top: 20px;
    padding: 10px 24px;
    border-radius: 8px;
    border: none;
    background: var(--btn);
    color: var(--btn-text);
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
  }

  /* Animations */
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>
</head>
<body>
<div class="container" id="app">
  <div class="skeleton" id="loading">
    <div class="skeleton-block sk-header"></div>
    <div class="skeleton-block sk-roadmap"></div>
    <div class="skeleton-block sk-badges"></div>
  </div>
</div>

<script>
(function() {
  var API_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/rc-onboarding';
  var SURVEY_URL = 'https://michaeldohyun.github.io/rc-webapp/survey.html';

  var XP_LEVELS = [
    { level: 1,  title: '\uCCAB \uBC1C\uC790\uAD6D',       min_xp: 0,     icon: '\uD83D\uDC5F' },
    { level: 2,  title: '\uC6CC\uBC0D\uC5C5 \uB7EC\uB108',     min_xp: 100,   icon: '\uD83C\uDFC3' },
    { level: 3,  title: '\uB9AC\uB4EC\uC744 \uCC3E\uB294 \uB7EC\uB108', min_xp: 300,   icon: '\uD83C\uDFBD' },
    { level: 4,  title: '\uAFB8\uC900\uD55C \uB7EC\uB108',     min_xp: 650,   icon: '\uD83D\uDCAA' },
    { level: 5,  title: '\uB3C4\uC804\uD558\uB294 \uB7EC\uB108',   min_xp: 1150,  icon: '\u26A1' },
    { level: 6,  title: '\uD398\uC774\uC2A4\uBA54\uC774\uCEE4',     min_xp: 1850,  icon: '\uD83C\uDFC5' },
    { level: 7,  title: '\uD6C8\uB828\uC758 \uB2EC\uC778',     min_xp: 2850,  icon: '\uD83C\uDFC6' },
    { level: 8,  title: '\uB9C8\uB77C\uD1A0\uB108',         min_xp: 4350,  icon: '\uD83E\uDD47' },
    { level: 9,  title: '\uB7EC\uB2DD \uB9C8\uC2A4\uD130',     min_xp: 6350,  icon: '\uD83D\uDC51' },
    { level: 10, title: '\uC804\uC124\uC758 \uB7EC\uB108',     min_xp: 9350,  icon: '\uD83D\uDC09' },
  ];

  var tg = window.Telegram && window.Telegram.WebApp;
  var initData = '';
  var userId = null;

  if (tg) {
    tg.ready();
    tg.expand();
    initData = tg.initData || '';
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      userId = tg.initDataUnsafe.user.id;
    }
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    var d = new Date(dateStr);
    return d.getFullYear() + '.' + String(d.getMonth() + 1).padStart(2, '0') + '.' + String(d.getDate()).padStart(2, '0');
  }

  function formatNumber(n) {
    if (n >= 10000) return (n / 10000).toFixed(1) + '\uB9CC';
    if (n >= 1000) return n.toLocaleString();
    return String(n);
  }

  async function fetchProfile() {
    if (!userId) throw new Error('\uD154\uB808\uADF8\uB7A8\uC5D0\uC11C \uC5F4\uC5B4\uC8FC\uC138\uC694');
    var res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'get_profile',
        telegram_user_id: userId,
        init_data: initData
      })
    });
    if (!res.ok) throw new Error('\uC11C\uBC84 \uC624\uB958 (' + res.status + ')');
    var data = await res.json();
    if (!data.success) throw new Error(data.error || '\uB370\uC774\uD130\uB97C \uBD88\uB7EC\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4');
    return data.profile;
  }

  function renderHeader(p) {
    var initial = (p.name || '?').charAt(0).toUpperCase();
    var xpPct = p.next_level_xp > 0 ? Math.min(100, Math.max(0, (p.current_xp / p.next_level_xp) * 100)) : 100;
    var sinceText = p.joined_date ? formatDate(p.joined_date) + '\uBD80\uD130 \uB7EC\uB2DD' : '';
    var totalHr = Math.floor(p.total_time_min / 60);
    var totalMin = p.total_time_min % 60;

    return '<div class="card profile-header">' +
      '<div class="profile-top">' +
        '<div class="avatar">' +
          '<div class="avatar-circle">' + escapeHtml(initial) + '</div>' +
          '<div class="avatar-badge">' + p.level + '</div>' +
        '</div>' +
        '<div class="profile-info">' +
          '<div class="profile-name">' + escapeHtml(p.name) + '</div>' +
          '<div class="profile-since">' + escapeHtml(sinceText) + '</div>' +
          '<div class="xp-row">' +
            '<div class="xp-bar"><div class="xp-fill" style="width:' + xpPct + '%"></div></div>' +
            '<span class="xp-label">Lv.' + p.level + '</span>' +
          '</div>' +
        '</div>' +
      '</div>' +
      '<div class="stats-grid">' +
        '<div class="stat-item"><div class="stat-value">' + formatNumber(p.total_runs) + '</div><div class="stat-label">\uB7EC\uB2DD</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + formatNumber(Math.round(p.total_distance_km)) + '</div><div class="stat-label">km</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + p.current_streak + '</div><div class="stat-label">\uC5F0\uC18D(\uC8FC)</div></div>' +
        '<div class="stat-item"><div class="stat-value">' + formatNumber(p.total_xp) + '</div><div class="stat-label">XP</div></div>' +
      '</div>' +
    '</div>';
  }

  function renderRoadmap(p) {
    var html = '<div class="card roadmap">' +
      '<div class="section-title">\u2B50 \uB808\uBCA8 \uB85C\uB4DC\uB9F5</div>' +
      '<div class="level-list">';

    for (var i = 0; i < XP_LEVELS.length; i++) {
      var lv = XP_LEVELS[i];
      var isCurrent = lv.level === p.level;
      var isReached = lv.level < p.level;
      var isLocked = lv.level > p.level;

      var rowClass = 'level-row';
      if (isCurrent) rowClass += ' current';
      else if (isReached) rowClass += ' reached';
      else rowClass += ' locked';

      html += '<div class="' + rowClass + '">';

      // Icon box
      if (isReached || isCurrent) {
        html += '<div class="level-icon-box">' + lv.level + '</div>';
      } else {
        html += '<div class="level-icon-box">' + lv.icon + '</div>';
      }

      // Info
      html += '<div class="level-info">' +
        '<div class="level-title">' + escapeHtml(lv.title) + '</div>' +
        '<div class="level-xp">' + lv.min_xp.toLocaleString() + ' XP</div>' +
      '</div>';

      // Tag
      if (isCurrent) {
        html += '<span class="level-tag current-tag">\uD604\uC7AC</span>';
      } else if (isReached) {
        html += '<span class="level-tag">\uB2EC\uC131</span>';
      } else {
        html += '<span class="level-lock">\uD83D\uDD12</span>';
      }

      html += '</div>';
    }

    html += '</div></div>';
    return html;
  }

  function renderMilestones(milestones) {
    if (!milestones || milestones.length === 0) return '';

    var achieved = milestones.filter(function(m) { return m.achieved; });
    var locked = milestones.filter(function(m) { return !m.achieved; });

    var html = '';

    // Achieved
    if (achieved.length > 0) {
      html += '<div class="card milestones-section">' +
        '<div class="section-title">\uD83C\uDFC6 \uD68D\uB4DD\uD55C \uBC30\uC9C0 <span class="badge-count">' + achieved.length + '/' + milestones.length + '</span></div>' +
        '<div class="milestone-grid">';
      achieved.forEach(function(m) {
        html += '<div class="milestone-card">' +
          '<div class="milestone-icon">' + m.icon + '</div>' +
          '<div class="milestone-title">' + escapeHtml(m.title) + '</div>' +
          '<div class="milestone-date">' + formatDate(m.achieved_at) + '</div>' +
        '</div>';
      });
      html += '</div></div>';
    }

    // Locked
    if (locked.length > 0) {
      html += '<div class="card milestones-section">' +
        '<div class="section-title">\uD83D\uDD12 \uBBF8\uD68D\uB4DD \uBC30\uC9C0 <span class="badge-count">' + locked.length + '</span></div>' +
        '<div class="milestone-grid">';
      locked.forEach(function(m) {
        var prog = m.progress || {};
        var pct = prog.target ? Math.min(100, (prog.current / prog.target) * 100) : 0;
        html += '<div class="milestone-card locked">' +
          '<div class="milestone-lock-icon">\uD83D\uDD12</div>' +
          '<div class="milestone-icon">' + m.icon + '</div>' +
          '<div class="milestone-title">' + escapeHtml(m.title) + '</div>';
        if (prog.target) {
          html += '<div class="milestone-prog-bar"><div class="milestone-prog-fill" style="width:' + pct + '%"></div></div>' +
            '<div class="milestone-prog-text">' + prog.current + ' / ' + prog.target + '</div>';
        }
        html += '</div>';
      });
      html += '</div></div>';
    }

    return html;
  }

  function renderCta() {
    return '<div class="cta-section">' +
      '<a href="' + SURVEY_URL + '" class="btn-primary">\uD504\uB85C\uD544 \uC218\uC815</a>' +
      '<button class="btn-secondary" id="btn-close">\uB2EB\uAE30</button>' +
    '</div>';
  }

  function renderError(msg) {
    return '<div class="error-container">' +
      '<div class="error-icon">\uD83D\uDE16</div>' +
      '<div class="error-title">\uBB38\uC81C\uAC00 \uBC1C\uC0DD\uD588\uC5B4\uC694</div>' +
      '<div class="error-msg">' + escapeHtml(msg) + '</div>' +
      '<button class="error-retry" onclick="location.reload()">\uB2E4\uC2DC \uC2DC\uB3C4</button>' +
    '</div>';
  }

  function renderAll(p) {
    var html = '';
    html += renderHeader(p);
    html += renderRoadmap(p);
    html += renderMilestones(p.milestones);
    html += renderCta();
    return html;
  }

  function attachEvents() {
    var closeBtn = document.getElementById('btn-close');
    if (closeBtn) {
      closeBtn.addEventListener('click', function() {
        if (tg) tg.close();
      });
    }
  }

  async function init() {
    var app = document.getElementById('app');
    try {
      var profile = await fetchProfile();
      app.innerHTML = renderAll(profile);
      attachEvents();
    } catch (e) {
      app.innerHTML = renderError(e.message || '\uC54C \uC218 \uC5C6\uB294 \uC624\uB958');
    }
  }

  init();
})();
</script>
</body>
</html>
