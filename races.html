<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ëŒ€íšŒ ê²€ìƒ‰</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: var(--tg-theme-bg-color, #ffffff);
    --text: var(--tg-theme-text-color, #000000);
    --hint: var(--tg-theme-hint-color, #999999);
    --link: var(--tg-theme-link-color, #2678b6);
    --btn: var(--tg-theme-button-color, #2678b6);
    --btn-text: var(--tg-theme-button-text-color, #ffffff);
    --secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
    --section-bg: var(--tg-theme-section-bg-color, var(--bg));
    --card-radius: 16px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--secondary-bg);
    color: var(--text);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  /* Filter bar */
  .filter-bar {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bg);
    padding: 12px 16px;
    border-bottom: 1px solid var(--secondary-bg);
  }

  .filter-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .filter-row + .filter-row { margin-top: 8px; }

  .region-select {
    flex: 1;
    padding: 8px 12px;
    border-radius: 10px;
    border: 1.5px solid var(--secondary-bg);
    background: var(--section-bg);
    color: var(--text);
    font-size: 14px;
    font-family: inherit;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
  }

  .chip-group {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .chip {
    padding: 6px 14px;
    border-radius: 20px;
    border: 1.5px solid var(--secondary-bg);
    background: var(--section-bg);
    color: var(--hint);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s;
    font-family: inherit;
  }

  .chip.active {
    background: var(--btn);
    color: var(--btn-text);
    border-color: var(--btn);
  }

  .result-count {
    font-size: 12px;
    color: var(--hint);
    margin-left: auto;
    white-space: nowrap;
  }

  /* Cards */
  .container { max-width: 480px; margin: 0 auto; padding: 8px 16px 24px; }

  .card {
    background: var(--section-bg);
    border-radius: var(--card-radius);
    padding: 16px;
    margin-bottom: 10px;
    position: relative;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 6px;
  }

  .badge {
    font-size: 11px;
    font-weight: 600;
    padding: 2px 8px;
    border-radius: 6px;
    white-space: nowrap;
  }

  .badge-open {
    background: #dcfce7;
    color: #16a34a;
  }

  .badge-upcoming {
    background: #fef9c3;
    color: #a16207;
  }

  .badge-closed {
    background: var(--secondary-bg);
    color: var(--hint);
  }

  .card-date {
    font-size: 13px;
    color: var(--hint);
    font-weight: 500;
  }

  .card-name {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 8px;
    line-height: 1.3;
  }

  .card-info {
    font-size: 13px;
    color: var(--hint);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .distance-tags {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
    margin: 8px 0;
  }

  .distance-tag {
    font-size: 12px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 12px;
    background: var(--secondary-bg);
    color: var(--text);
  }

  .reg-link {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 8px;
    padding: 8px 16px;
    border-radius: 10px;
    background: var(--btn);
    color: var(--btn-text);
    text-decoration: none;
    font-size: 13px;
    font-weight: 600;
  }

  /* States */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--hint);
  }

  .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state-title { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
  .empty-state-desc { font-size: 14px; line-height: 1.5; }

  /* Skeleton */
  .skeleton-card {
    background: var(--section-bg);
    border-radius: var(--card-radius);
    padding: 16px;
    margin-bottom: 10px;
  }

  .skeleton-line {
    height: 14px;
    border-radius: 6px;
    background: var(--secondary-bg);
    margin-bottom: 8px;
    animation: pulse 1.2s ease-in-out infinite;
  }

  .skeleton-line.w60 { width: 60%; }
  .skeleton-line.w80 { width: 80%; }
  .skeleton-line.w40 { width: 40%; }
  .skeleton-line.h20 { height: 20px; }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Error */
  .error-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--hint);
  }

  .retry-btn {
    margin-top: 12px;
    padding: 10px 24px;
    border-radius: 10px;
    background: var(--btn);
    color: var(--btn-text);
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
  }
</style>
</head>
<body>

<div class="filter-bar">
  <div class="filter-row">
    <select id="regionFilter" class="region-select">
      <option value="">ì „ì²´ ì§€ì—­</option>
      <option value="ì„œìš¸">ì„œìš¸</option>
      <option value="ê²½ê¸°">ê²½ê¸°</option>
      <option value="ì¸ì²œ">ì¸ì²œ</option>
      <option value="ê°•ì›">ê°•ì›</option>
      <option value="ì¶©ë¶">ì¶©ë¶</option>
      <option value="ì¶©ë‚¨">ì¶©ë‚¨</option>
      <option value="ëŒ€ì „">ëŒ€ì „</option>
      <option value="ì„¸ì¢…">ì„¸ì¢…</option>
      <option value="ê²½ë¶">ê²½ë¶</option>
      <option value="ê²½ë‚¨">ê²½ë‚¨</option>
      <option value="ëŒ€êµ¬">ëŒ€êµ¬</option>
      <option value="ìš¸ì‚°">ìš¸ì‚°</option>
      <option value="ë¶€ì‚°">ë¶€ì‚°</option>
      <option value="ì „ë¶">ì „ë¶</option>
      <option value="ì „ë‚¨">ì „ë‚¨</option>
      <option value="ê´‘ì£¼">ê´‘ì£¼</option>
      <option value="ì œì£¼">ì œì£¼</option>
    </select>
    <span id="resultCount" class="result-count"></span>
  </div>
  <div class="filter-row">
    <div id="distanceChips" class="chip-group">
      <button class="chip active" data-value="">ì „ì²´</button>
      <button class="chip" data-value="í’€">í’€</button>
      <button class="chip" data-value="í•˜í”„">í•˜í”„</button>
      <button class="chip" data-value="10km">10km</button>
      <button class="chip" data-value="5km">5km</button>
    </div>
  </div>
</div>

<div class="container" id="raceList"></div>

<script>
(function() {
  const API_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/marathon-collector';
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
  }

  let allRaces = [];
  let currentRegion = '';
  let currentDistance = '';

  const regionFilter = document.getElementById('regionFilter');
  const distanceChips = document.getElementById('distanceChips');
  const raceList = document.getElementById('raceList');
  const resultCount = document.getElementById('resultCount');

  // URL paramsë¡œ ì´ˆê¸° í•„í„° ì„¤ì •
  const params = new URLSearchParams(window.location.search);
  if (params.get('region')) {
    currentRegion = params.get('region');
    regionFilter.value = currentRegion;
  }
  if (params.get('distance')) {
    currentDistance = params.get('distance');
    distanceChips.querySelectorAll('.chip').forEach(c => {
      c.classList.toggle('active', c.dataset.value === currentDistance);
    });
  }

  // ì´ë²¤íŠ¸
  regionFilter.addEventListener('change', () => {
    currentRegion = regionFilter.value;
    renderRaces();
  });

  distanceChips.addEventListener('click', (e) => {
    const chip = e.target.closest('.chip');
    if (!chip) return;
    currentDistance = chip.dataset.value;
    distanceChips.querySelectorAll('.chip').forEach(c => {
      c.classList.toggle('active', c.dataset.value === currentDistance);
    });
    renderRaces();
  });

  // ë¡œë”©
  function showLoading() {
    raceList.innerHTML = Array.from({ length: 4 }, () => `
      <div class="skeleton-card">
        <div class="skeleton-line w40"></div>
        <div class="skeleton-line w80 h20"></div>
        <div class="skeleton-line w60"></div>
        <div class="skeleton-line w40"></div>
      </div>
    `).join('');
  }

  function showError() {
    raceList.innerHTML = `
      <div class="error-state">
        <div class="empty-state-icon">ğŸ˜µ</div>
        <div class="empty-state-title">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>
        <div class="empty-state-desc">ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>
        <button class="retry-btn" onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>
      </div>
    `;
    resultCount.textContent = '';
  }

  function showEmpty() {
    raceList.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ”</div>
        <div class="empty-state-title">ì¡°ê±´ì— ë§ëŠ” ëŒ€íšŒê°€ ì—†ì–´ìš”</div>
        <div class="empty-state-desc">ë‹¤ë¥¸ ì§€ì—­ì´ë‚˜ ì¢…ëª©ì„ ì„ íƒí•´ë³´ì„¸ìš”.</div>
      </div>
    `;
  }

  // ë‚ ì§œ í¬ë§·
  function formatDate(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
    const m = d.getMonth() + 1;
    const dd = d.getDate();
    const day = days[d.getDay()];
    return `${d.getFullYear()}.${String(m).padStart(2,'0')}.${String(dd).padStart(2,'0')} (${day})`;
  }

  function formatShortDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr + 'T00:00:00');
    return `${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
  }

  // ì ‘ìˆ˜ ìƒíƒœ ë°°ì§€
  function badgeHtml(status) {
    if (status === 'open') return '<span class="badge badge-open">ì ‘ìˆ˜ì¤‘</span>';
    if (status === 'upcoming') return '<span class="badge badge-upcoming">ì ‘ìˆ˜ì˜ˆì •</span>';
    if (status === 'closed') return '<span class="badge badge-closed">ë§ˆê°</span>';
    return '';
  }

  // í•„í„° + ë Œë”
  function renderRaces() {
    let filtered = allRaces;

    if (currentRegion) {
      filtered = filtered.filter(r => r.region === currentRegion);
    }

    if (currentDistance) {
      filtered = filtered.filter(r =>
        r.distances && r.distances.some(d => d.includes(currentDistance))
      );
    }

    resultCount.textContent = `${filtered.length}ê°œ`;

    if (filtered.length === 0) {
      showEmpty();
      return;
    }

    raceList.innerHTML = filtered.map(race => {
      const distTags = (race.distances || [])
        .map(d => `<span class="distance-tag">${d}</span>`)
        .join('');

      const regPeriod = (race.registration_start || race.registration_end)
        ? `<div class="card-info">ğŸ“ ì ‘ìˆ˜: ${formatShortDate(race.registration_start)} ~ ${formatShortDate(race.registration_end)}</div>`
        : '';

      const organizer = race.organizer
        ? `<div class="card-info">ğŸ¢ ${race.organizer}</div>`
        : '';

      const regBtn = race.registration_url
        ? `<a class="reg-link" href="${race.registration_url}" target="_blank" rel="noopener">ì ‘ìˆ˜ í˜ì´ì§€ â†’</a>`
        : '';

      const location = race.location || race.region || '';

      return `
        <div class="card">
          <div class="card-header">
            ${badgeHtml(race.registration_status)}
            <span class="card-date">${formatDate(race.race_date)}</span>
          </div>
          <div class="card-name">${race.name}</div>
          ${location ? `<div class="card-info">ğŸ“ ${location}</div>` : ''}
          ${distTags ? `<div class="distance-tags">${distTags}</div>` : ''}
          ${organizer}
          ${regPeriod}
          ${regBtn}
        </div>
      `;
    }).join('');
  }

  // ë°ì´í„° ë¡œë“œ
  async function fetchRaces() {
    showLoading();
    try {
      const res = await fetch(`${API_URL}?format=json`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      allRaces = await res.json();
      renderRaces();
    } catch (e) {
      console.error('Fetch races error:', e);
      showError();
    }
  }

  fetchRaces();
})();
</script>
</body>
</html>
