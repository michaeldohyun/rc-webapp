<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Running Coach í”„ë¡œí•„</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --tg-theme-bg-color: #ffffff;
      --tg-theme-text-color: #000000;
      --tg-theme-hint-color: #999999;
      --tg-theme-link-color: #2678b6;
      --tg-theme-button-color: #2678b6;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-secondary-bg-color: #f0f0f0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 400px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 22px;
      margin-bottom: 6px;
    }

    .header p {
      color: var(--tg-theme-hint-color);
      font-size: 14px;
    }

    /* Steps */
    .step {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .step.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Step indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .step-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--tg-theme-hint-color);
      opacity: 0.3;
      transition: all 0.3s;
    }

    .step-dot.active {
      opacity: 1;
      background: var(--tg-theme-button-color);
      width: 24px;
      border-radius: 4px;
    }

    .step-dot.done {
      opacity: 1;
      background: #4CAF50;
    }

    .step-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .step-desc {
      color: var(--tg-theme-hint-color);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 20px;
    }

    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: opacity 0.2s;
    }

    .btn:active { opacity: 0.7; }

    .btn-primary {
      background: var(--tg-theme-button-color);
      color: var(--tg-theme-button-text-color);
    }

    .btn-ghost {
      background: transparent;
      color: var(--tg-theme-hint-color);
      font-size: 14px;
      font-weight: 400;
      padding: 10px;
    }

    .btn + .btn { margin-top: 10px; }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Input group */
    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--tg-theme-hint-color);
      border-radius: 10px;
      font-size: 15px;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-family: inherit;
    }

    .input-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    .input-group input:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: var(--tg-theme-button-color);
    }

    .input-group .hint {
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      margin-top: 4px;
    }

    /* Tab selector */
    .tab-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .tab-selector label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      width: 100%;
    }

    .tab-options {
      display: flex;
      gap: 8px;
      width: 100%;
    }

    .tab-option {
      flex: 1;
      padding: 10px 4px;
      border: 1.5px solid var(--tg-theme-hint-color);
      border-radius: 10px;
      text-align: center;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--tg-theme-text-color);
      opacity: 0.7;
      white-space: nowrap;
    }

    .tab-option.selected {
      border-color: var(--tg-theme-button-color);
      background: rgba(38, 120, 182, 0.08);
      opacity: 1;
      font-weight: 600;
    }

    /* Toggle chips */
    .chip-group {
      margin-bottom: 20px;
    }

    .chip-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .chip-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .chip {
      padding: 8px 14px;
      border: 1.5px solid var(--tg-theme-hint-color);
      border-radius: 20px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--tg-theme-text-color);
      opacity: 0.7;
    }

    .chip.selected {
      border-color: var(--tg-theme-button-color);
      background: rgba(38, 120, 182, 0.08);
      opacity: 1;
      font-weight: 600;
    }

    /* Card selector */
    .card-group {
      margin-bottom: 20px;
    }

    .card-group > label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .card-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-option {
      padding: 14px;
      border: 1.5px solid var(--tg-theme-hint-color);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      opacity: 0.7;
      font-size: 14px;
      font-weight: 500;
    }

    .card-option.selected {
      border-color: var(--tg-theme-button-color);
      background: rgba(38, 120, 182, 0.08);
      opacity: 1;
      font-weight: 600;
    }

    /* Navigation row */
    .nav-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .nav-row .btn {
      flex: 1;
    }

    /* Status / complete */
    .status {
      text-align: center;
      padding: 32px 0;
    }

    .status .icon {
      font-size: 56px;
      margin-bottom: 16px;
    }

    .status .message {
      font-size: 14px;
      color: var(--tg-theme-hint-color);
      line-height: 1.6;
      margin-top: 12px;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-text {
      color: #e74c3c;
      font-size: 13px;
      margin-top: 8px;
      text-align: center;
    }

    /* Suggestion chips */
    .suggestion-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 16px;
    }

    .suggestion-chip {
      padding: 6px 12px;
      border: 1px solid var(--tg-theme-hint-color);
      border-radius: 16px;
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .suggestion-chip:active {
      background: rgba(38, 120, 182, 0.08);
      border-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-color);
    }

    .chip-recommend {
      border-color: var(--tg-theme-button-color);
      color: var(--tg-theme-button-color);
      opacity: 0.85;
    }

    /* Location search */
    #location-search-wrapper {
      position: relative;
    }

    #location-search {
      width: 100%;
      padding: 12px;
      border: 1.5px solid var(--tg-theme-hint-color);
      border-radius: 10px;
      font-size: 15px;
      background: var(--tg-theme-bg-color);
      color: var(--tg-theme-text-color);
      font-family: inherit;
      transition: border-color 0.2s;
    }

    #location-search:focus {
      outline: none;
      border-color: var(--tg-theme-button-color);
    }

    .location-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--tg-theme-bg-color);
      border: 1.5px solid var(--tg-theme-hint-color);
      border-top: none;
      border-radius: 0 0 10px 10px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .location-results.show {
      display: block;
    }

    .location-result-item {
      padding: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
      border-bottom: 1px solid var(--tg-theme-hint-color);
      opacity: 0.7;
    }

    .location-result-item:last-child {
      border-bottom: none;
    }

    .location-result-item:active {
      background: rgba(38, 120, 182, 0.08);
    }

    .location-result-item .result-name {
      font-weight: 500;
    }

    .location-result-item .result-match {
      font-size: 12px;
      color: var(--tg-theme-hint-color);
      margin-top: 2px;
    }

    .selected-location {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: rgba(38, 120, 182, 0.08);
      border: 1.5px solid var(--tg-theme-button-color);
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
    }

    .selected-location .change-link {
      font-size: 13px;
      font-weight: 400;
      color: var(--tg-theme-link-color);
      cursor: pointer;
      margin-left: auto;
    }
    /* Training method cards (2-column grid) */
    .method-cards {
      flex-direction: row !important;
      flex-wrap: wrap;
      gap: 8px;
    }
    .method-cards .card-option {
      flex: 1 1 calc(50% - 4px);
      flex-direction: column;
      display: flex;
      align-items: flex-start;
      text-align: left;
      padding: 10px 12px;
    }
    .method-cards .card-option strong {
      font-size: 13px;
    }
    .card-desc {
      font-size: 11px;
      color: var(--tg-theme-hint-color);
      margin-top: 2px;
      line-height: 1.3;
    }
    .method-cards .card-option.selected .card-desc {
      color: var(--tg-theme-link-color);
    }
    .method-detail-link {
      display: block;
      font-size: 13px;
      color: var(--tg-theme-link-color);
      text-decoration: none;
      text-align: right;
      margin-top: 4px;
      margin-bottom: 16px;
    }

    /* Bumper page */
    .bumper-content {
      text-align: center;
      padding: 32px 0 24px;
    }
    .bumper-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    .bumper-content h2 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
    }
    .bumper-content > p {
      color: var(--tg-theme-hint-color);
      font-size: 15px;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .bumper-list {
      list-style: none;
      text-align: left;
      margin: 0 auto 20px;
      max-width: 260px;
    }
    .bumper-list li {
      font-size: 14px;
      padding: 6px 0;
      position: relative;
      padding-left: 24px;
    }
    .bumper-list li::before {
      content: 'âœ“';
      position: absolute;
      left: 0;
      color: var(--tg-theme-button-color);
      font-weight: 700;
    }
    .bumper-time {
      font-size: 13px;
      color: var(--tg-theme-hint-color);
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ëŸ¬ë‹ í”„ë¡œí•„</h1>
      <p>ì½”ì¹˜ê°€ ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì¡°ì–¸ì„ ë“œë¦´ ìˆ˜ ìˆë„ë¡</p>
    </div>

    <div class="step-indicator">
      <div class="step-dot active" id="dot-1"></div>
      <div class="step-dot" id="dot-2"></div>
      <div class="step-dot" id="dot-3"></div>
      <div class="step-dot" id="dot-4"></div>
    </div>

    <!-- Bumper: ì˜¨ë³´ë”© ì‹œì—ë§Œ ë…¸ì¶œ -->
    <div class="step" id="step-bumper">
      <div class="bumper-content">
        <div class="bumper-icon">ğŸ“‹</div>
        <h2>ë§ì¶¤ í›ˆë ¨ë²•ì„ ì¶”ì²œí•´ë“œë¦´ê²Œìš”</h2>
        <p>ê°„ë‹¨í•œ í”„ë¡œí•„ì„ ì…ë ¥í•´ì£¼ì‹œë©´,<br>ë‹¹ì‹ ì—ê²Œ ë”± ë§ëŠ” í›ˆë ¨ë²•ì„ ì°¾ì•„ë“œë ¤ìš”.</p>
        <ul class="bumper-list">
          <li>ëŸ¬ë‹ ëª©í‘œì™€ í˜„ì¬ ìƒíƒœ íŒŒì•…</li>
          <li>AIê°€ ìµœì  í›ˆë ¨ë²• ë¶„ì„</li>
          <li>ê°œì¸ ë§ì¶¤ ì£¼ê°„ ê³„íš ìƒì„±</li>
        </ul>
        <p class="bumper-time">ì•½ 1~2ë¶„ì´ë©´ ì¶©ë¶„í•´ìš”</p>
      </div>
      <button class="btn btn-primary" onclick="goToStep(1)">í”„ë¡œí•„ ì…ë ¥í•˜ê¸°</button>
    </div>

    <!-- Step 1: ëª©í‘œ -->
    <div class="step active" id="step-1">
      <div class="step-title">ì–´ë–¤ ëª©í‘œë¥¼ ê°€ì§€ê³  ê³„ì„¸ìš”?</div>
      <div class="step-desc">ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”. êµ¬ì²´ì ì¼ìˆ˜ë¡ ì¢‹ì•„ìš”.</div>

      <div class="input-group">
        <label>ëŸ¬ë‹ ëª©í‘œ</label>
        <input type="text" id="goal-text" placeholder="ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë˜ì—ì„œ ì„ íƒ">
        <div class="suggestion-chips">
          <span class="suggestion-chip" onclick="fillGoal(this)">í’€ë§ˆë¼í†¤ ì™„ì£¼</span>
          <span class="suggestion-chip" onclick="fillGoal(this)">í•˜í”„ë§ˆë¼í†¤ ì™„ì£¼</span>
          <span class="suggestion-chip" onclick="fillGoal(this)">10K ê¸°ë¡ ë‹¨ì¶•</span>
          <span class="suggestion-chip" onclick="fillGoal(this)">5K ê¸°ë¡ ë‹¨ì¶•</span>
          <span class="suggestion-chip" onclick="fillGoal(this)">ê¾¸ì¤€íˆ ê±´ê°•í•˜ê²Œ</span>
          <span class="suggestion-chip" onclick="fillGoal(this)">ë‹¤ì´ì–´íŠ¸</span>
        </div>
      </div>

      <div class="input-group">
        <label>ëª©í‘œ ì‹œì </label>
        <input type="text" id="target-date" placeholder="ì˜ˆ: 2025ë…„ 3ì›”, ì˜¬í•´ ì•ˆì—, ì•„ì§ ë¯¸ì •">
        <div class="hint">ë¹„ì›Œë„ ê´œì°®ì•„ìš”</div>
      </div>

      <button class="btn btn-primary" onclick="goToStep(2)">ë‹¤ìŒ</button>
    </div>

    <!-- Step 2: í˜„ì¬ ëŸ¬ë‹ -->
    <div class="step" id="step-2">
      <div class="step-title">ì§€ê¸ˆ ëŸ¬ë‹ì€ ì–´ë–»ê²Œ í•˜ê³  ê³„ì„¸ìš”?</div>
      <div class="step-desc">ëŒ€ëµì ìœ¼ë¡œë§Œ ì•Œë ¤ì£¼ì…”ë„ ë¼ìš”.</div>

      <div class="tab-selector">
        <div>
          <label>ì£¼ê°„ ëŸ¬ë‹ íšŸìˆ˜</label>
          <div class="tab-options">
            <div class="tab-option" data-value="1-2" onclick="selectTab(this)">1~2íšŒ</div>
            <div class="tab-option" data-value="3-4" onclick="selectTab(this)">3~4íšŒ</div>
            <div class="tab-option" data-value="5+" onclick="selectTab(this)">5íšŒ+</div>
          </div>
        </div>
      </div>

      <div class="chip-group">
        <label>ì£¼ë¡œ ë›°ëŠ” ì‹œê°„ëŒ€</label>
        <div class="chip-options" id="run-time-chips">
          <div class="chip" data-value="weekday_dawn" onclick="toggleChip(this)">í‰ì¼ ìƒˆë²½</div>
          <div class="chip" data-value="weekday_morning" onclick="toggleChip(this)">í‰ì¼ ì•„ì¹¨</div>
          <div class="chip" data-value="weekday_evening" onclick="toggleChip(this)">í‰ì¼ ì €ë…</div>
          <div class="chip" data-value="weekend_dawn" onclick="toggleChip(this)">ì£¼ë§ ìƒˆë²½</div>
          <div class="chip" data-value="weekend_morning" onclick="toggleChip(this)">ì£¼ë§ ì•„ì¹¨</div>
          <div class="chip" data-value="weekend_afternoon" onclick="toggleChip(this)">ì£¼ë§ ì˜¤í›„</div>
        </div>
      </div>

      <div class="chip-group">
        <label>ì£¼ë¡œ ë›°ëŠ” ì§€ì—­</label>
        <div id="location-search-wrapper">
          <input type="text" id="location-search" placeholder="ë„ì‹œ ë˜ëŠ” êµ¬ ì´ë¦„ ê²€ìƒ‰ (ì˜ˆ: ì•ˆì–‘, ì„œì´ˆêµ¬)" autocomplete="off">
          <div id="location-results" class="location-results"></div>
        </div>
        <div id="location-selected" style="display:none">
          <div class="selected-location">
            <span id="location-display-name"></span>
            <span class="change-link" onclick="resetLocationSearch()">ë³€ê²½</span>
          </div>
        </div>
        <div class="hint" style="font-size:12px;color:var(--tg-theme-hint-color);margin-top:4px;">ë‚ ì”¨ ì˜ˆë³´ì— ì‚¬ìš©ë©ë‹ˆë‹¤</div>
      </div>

      <div class="input-group">
        <label>ë©”ëª¨ (ì„ íƒ)</label>
        <textarea id="run-pattern-note" placeholder="ì˜ˆ: ì£¼ë§ì—ë§Œ ì¥ê±°ë¦¬, ì¡´2 ìœ„ì£¼ë¡œ í›ˆë ¨ ì¤‘" rows="2"></textarea>
      </div>

      <button class="btn btn-primary" onclick="goToStep(hideMethodStep ? 4 : 3)">ë‹¤ìŒ</button>
      <div class="nav-row">
        <button class="btn btn-ghost" onclick="goToStep(1)">ì´ì „</button>
      </div>
    </div>

    <!-- Step 3: í›ˆë ¨ë²• -->
    <div class="step" id="step-3">
      <div class="step-title">ì ìš©í•˜ê³  ì‹¶ì€ í›ˆë ¨ë²•ì´ ìˆë‚˜ìš”?</div>
      <div class="step-desc">ì˜ ëª¨ë¥´ê² ë‹¤ë©´ ì„ íƒí•˜ì§€ ì•Šê³  ë„˜ì–´ê°€ë„ ê´œì°®ì•„ìš”.</div>

      <div class="card-group" id="method-group">
        <label>í›ˆë ¨ë²• <span style="font-weight:400; color:var(--tg-theme-hint-color)">(ì„ íƒ)</span></label>
        <div class="card-options method-cards" id="method-cards">
          <div class="card-option" data-value="galloway" onclick="selectCard(this, 'method-cards')">
            <strong>ê°¤ëŸ¬ì›¨ì´</strong>
            <span class="card-desc">ë‹¬ë¦¬ê¸°+ê±·ê¸° ë²ˆê°ˆì•„! ë¶€ìƒ ê±±ì • ì—†ì´ ì‹œì‘</span>
          </div>
          <div class="card-option" data-value="maf" onclick="selectCard(this, 'method-cards')">
            <strong>MAF ì €ì‹¬ë°•</strong>
            <span class="card-desc">ì‹¬ë°•ìˆ˜ í•˜ë‚˜ë§Œ ì§€í‚¤ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ë¹¨ë¼ì ¸ìš”</span>
          </div>
          <div class="card-option" data-value="80_20" onclick="selectCard(this, 'method-cards')">
            <strong>80/20 ëŸ¬ë‹</strong>
            <span class="card-desc">80%ëŠ” í¸í•˜ê²Œ, 20%ë§Œ ë¹¡ì„¸ê²Œ</span>
          </div>
          <div class="card-option" data-value="jack_daniels" onclick="selectCard(this, 'method-cards')">
            <strong>ì­ ë‹¤ë‹ˆì—˜ìŠ¤</strong>
            <span class="card-desc">ë‚´ ê¸°ë¡ì— ë§ëŠ” ê³¼í•™ì  í˜ì´ìŠ¤ ì‹œìŠ¤í…œ</span>
          </div>
          <div class="card-option" data-value="hansons" onclick="selectCard(this, 'method-cards')">
            <strong>í•œìŠ¨</strong>
            <span class="card-desc">ë§¤ì¼ ê¾¸ì¤€íˆ! ë§ˆë¼í†¤ í›„ë°˜ì´ ê°•í•´ì ¸ìš”</span>
          </div>
          <div class="card-option" data-value="norwegian" onclick="selectCard(this, 'method-cards')">
            <strong>ë…¸ë¥´ì›¨ì´</strong>
            <span class="card-desc">í•˜ë£¨ ë‘ ë²ˆ ì—­ì¹˜ í›ˆë ¨! ìµœì‹  íŠ¸ë Œë“œ</span>
          </div>
          <div class="card-option" data-value="pfitzinger" onclick="selectCard(this, 'method-cards')">
            <strong>í”¼ì¹˜ì§„ì €</strong>
            <span class="card-desc">ë§ˆë¼í†¤ ê¸°ë¡ ê°±ì‹  ì „ìš© ê³ ê¸‰ í”„ë¡œê·¸ë¨</span>
          </div>
          <div class="card-option" data-value="lydiard" onclick="selectCard(this, 'method-cards')">
            <strong>ë¦¬ë””ì–´ë“œ</strong>
            <span class="card-desc">ëª¨ë“  í›ˆë ¨ë²•ì˜ ì›ì¡°. ìƒê¸‰ììš©</span>
          </div>
        </div>
        <a href="https://michaeldohyun.github.io/rc-webapp/methods.html?from=survey" class="method-detail-link">í›ˆë ¨ë²• ìì„¸íˆ ë³´ê¸° â†’</a>
      </div>

      <button class="btn btn-primary" onclick="goToStep(4)">ë‹¤ìŒ</button>
      <div class="nav-row">
        <button class="btn btn-ghost" onclick="goToStep(2)">ì´ì „</button>
      </div>
    </div>

    <!-- Step 4: ì½”ì¹­ ì„ í˜¸ -->
    <div class="step" id="step-4">
      <div class="step-title">ì–´ë–¤ ì½”ì¹­ì„ ì›í•˜ì‹œë‚˜ìš”?</div>
      <div class="step-desc">ì½”ì¹­ ë°©í–¥ì„ ë§ì¶”ëŠ” ë° ì°¸ê³ í• ê²Œìš”.</div>

      <div class="card-group">
        <label>ê°€ì¥ ì¤‘ìš”í•œ ê²ƒ</label>
        <div class="card-options" id="priority-cards">
          <div class="card-option" data-value="injury_prevention" onclick="selectCard(this, 'priority-cards')">ë¶€ìƒ ì—†ì´ ì•ˆì „í•˜ê²Œ</div>
          <div class="card-option" data-value="performance" onclick="selectCard(this, 'priority-cards')">ê¸°ë¡/í˜ì´ìŠ¤ í–¥ìƒ</div>
          <div class="card-option" data-value="consistency" onclick="selectCard(this, 'priority-cards')">ê¾¸ì¤€í•œ ìŠµê´€ ë§Œë“¤ê¸°</div>
          <div class="card-option" data-value="race_prep" onclick="selectCard(this, 'priority-cards')">ëŒ€íšŒ ì¤€ë¹„</div>
        </div>
      </div>

      <div class="card-group">
        <label>í›ˆë ¨ ê³„íš ìŠ¤íƒ€ì¼</label>
        <div class="card-options" id="style-cards">
          <div class="card-option" data-value="structured" onclick="selectCard(this, 'style-cards')">ê³„íšì„ ì„¸ìš°ê³  ì§€í‚¤ëŠ” í¸</div>
          <div class="card-option" data-value="flexible" onclick="selectCard(this, 'style-cards')">ê·¸ë•Œê·¸ë•Œ ìœ ì—°í•˜ê²Œ</div>
        </div>
      </div>

      <div class="input-group">
        <label>ì¶”ê°€ ìš”ì²­ (ì„ íƒ)</label>
        <textarea id="additional-note" placeholder="ì½”ì¹˜ì—ê²Œ ë¯¸ë¦¬ ì•Œë ¤ì£¼ê³  ì‹¶ì€ ê²ƒì´ ìˆë‹¤ë©´" rows="2"></textarea>
      </div>

      <button class="btn btn-primary" id="btn-submit" onclick="submitSurvey()">ì™„ë£Œ</button>
      <div class="error-text" id="error-msg" style="display:none"></div>
      <div class="nav-row">
        <button class="btn btn-ghost" onclick="goToStep(hideMethodStep ? 2 : 3)">ì´ì „</button>
        <button class="btn btn-ghost" onclick="skipToEnd()">ê±´ë„ˆë›°ê³  ì™„ë£Œ</button>
      </div>
    </div>

    <!-- Complete -->
    <div class="step" id="step-complete">
      <div class="status">
        <div class="icon">&#x1F3C3;</div>
        <div class="step-title">í”„ë¡œí•„ ì„¤ì • ì™„ë£Œ!</div>
        <div class="message">
          ì´ì œ ë´‡ì—ê²Œ ììœ ë¡­ê²Œ ë§ì„ ê±¸ì–´ë³´ì„¸ìš”.<br>
          ë‹¹ì‹ ì—ê²Œ ë§ëŠ” ì½”ì¹­ì„ ì‹œì‘í• ê²Œìš”.
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://dotsosqsftympgdescvz.supabase.co/functions/v1/rc-onboarding';

    const tg = window.Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      // from=appì—ì„œ ì—´ë ¸ìœ¼ë©´ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ í‘œì‹œ
      const params = new URLSearchParams(window.location.search);
      if (params.get('from') === 'app' && tg.BackButton) {
        tg.BackButton.show();
        tg.BackButton.onClick(function() { tg.close(); });
      }
    }

    let currentStep = 1;
    let hideMethodStep = true;
    const params = new URLSearchParams(window.location.search);
    const isOnboarding = params.get('from') !== 'app';

    // --- Prefill ---

    async function loadExistingSurvey() {
      const user = tg?.initDataUnsafe?.user;
      if (!user?.id || !tg?.initData) return;

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'get_survey',
            telegram_user_id: user.id,
            init_data: tg.initData,
          }),
        });
        const result = await res.json();
        if (!result.success || !result.survey) return;

        const s = result.survey;

        // Step 1
        if (s.goal_text) document.getElementById('goal-text').value = s.goal_text;
        if (s.target_date) document.getElementById('target-date').value = s.target_date;

        // Step 2: weekly frequency tab
        if (s.weekly_frequency) {
          const tab = document.querySelector(`.tab-option[data-value="${s.weekly_frequency}"]`);
          if (tab) tab.classList.add('selected');
        }

        // Step 2: run times chips
        if (Array.isArray(s.run_times)) {
          s.run_times.forEach(v => {
            const chip = document.querySelector(`#run-time-chips .chip[data-value="${v}"]`);
            if (chip) chip.classList.add('selected');
          });
        }

        // Step 2: pattern note
        if (s.run_pattern_note) document.getElementById('run-pattern-note').value = s.run_pattern_note;

        // Step 2: location
        if (s.default_location) {
          const locName = s.default_location.name || '';
          if (locName) {
            const found = LOCATION_SEARCH_DATA.find(loc => loc.name === locName);
            if (found) {
              selectLocation(found);
            } else if (s.default_location.lat) {
              selectLocation({ name: locName, display: locName, lat: s.default_location.lat, lon: s.default_location.lon, keywords: [locName] });
            }
          }
        }

        // Step 3: training method â€” ì´ë¯¸ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ Step 3 í‘œì‹œ
        if (s.training_method && s.training_method !== 'none' && s.training_method !== 'pending_recommend') {
          hideMethodStep = false;
          const methodCard = document.querySelector(`#method-cards .card-option[data-value="${s.training_method}"]`);
          if (methodCard) methodCard.classList.add('selected');
        }

        // Step 4: priority
        if (s.priority) {
          const card = document.querySelector(`#priority-cards .card-option[data-value="${s.priority}"]`);
          if (card) card.classList.add('selected');
        }

        // Step 4: plan style
        if (s.plan_style) {
          const card = document.querySelector(`#style-cards .card-option[data-value="${s.plan_style}"]`);
          if (card) card.classList.add('selected');
        }

        // Step 4: additional note
        if (s.additional_note) document.getElementById('additional-note').value = s.additional_note;

      } catch (e) {
        console.error('Prefill error:', e);
      }
    }

    loadExistingSurvey().then(() => {
      if (hideMethodStep) {
        document.getElementById('dot-3').style.display = 'none';
        document.getElementById('step-3').style.display = 'none';
      }
      // ì˜¨ë³´ë”© ëª¨ë“œ: ë²”í¼ í˜ì´ì§€ ë¨¼ì € í‘œì‹œ
      if (isOnboarding && hideMethodStep) {
        document.getElementById('step-1').classList.remove('active');
        document.getElementById('step-bumper').classList.add('active');
        document.querySelector('.step-indicator').style.display = 'none';
        document.querySelector('.header').style.display = 'none';
        currentStep = 'bumper';
      }
    });

    // --- Navigation ---

    function goToStep(step) {
      const prev = currentStep;
      document.getElementById('step-' + prev)?.classList.remove('active');
      document.getElementById('dot-' + prev)?.classList.remove('active');

      // ë²”í¼ì—ì„œ step-1ë¡œ ë„˜ì–´ê°ˆ ë•Œ indicator/header ë³µì›
      if (prev === 'bumper' && typeof step === 'number') {
        document.querySelector('.step-indicator').style.display = '';
        document.querySelector('.header').style.display = '';
      }

      if (typeof step === 'number' && typeof prev === 'number' && step < prev) {
        document.getElementById('dot-' + prev)?.classList.remove('done');
        for (let i = step; i <= prev; i++) {
          document.getElementById('dot-' + i)?.classList.remove('done');
        }
      } else if (typeof prev === 'number') {
        document.getElementById('dot-' + prev)?.classList.add('done');
      }

      currentStep = step;
      document.getElementById('step-' + step)?.classList.add('active');
      if (typeof step === 'number') {
        document.getElementById('dot-' + step)?.classList.add('active');
      }
    }

    function skipToEnd() {
      submitSurvey();
    }

    // --- Tab selector ---

    function selectTab(el) {
      const siblings = el.parentElement.querySelectorAll('.tab-option');
      siblings.forEach(s => s.classList.remove('selected'));
      el.classList.add('selected');
    }

    // --- Goal suggestion ---

    function fillGoal(el) {
      document.getElementById('goal-text').value = el.textContent;
    }

    // --- Toggle chips ---

    function toggleChip(el) {
      el.classList.toggle('selected');
    }

    // --- Location search autocomplete ---

    const LOCATION_SEARCH_DATA = [
      // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ
      { name: 'ì„œìš¸', display: 'ì„œìš¸', lat: 37.5665, lon: 126.978, keywords: ['ì„œìš¸','ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'] },
      { name: 'ë¶€ì‚°', display: 'ë¶€ì‚°', lat: 35.1796, lon: 129.0756, keywords: ['ë¶€ì‚°','í•´ìš´ëŒ€êµ¬','ìˆ˜ì˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë™ë˜êµ¬','ê¸ˆì •êµ¬','ì—°ì œêµ¬','ì‚¬í•˜êµ¬','ì‚¬ìƒêµ¬','ì˜ë„êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë¶êµ¬','ë™êµ¬','ì„œêµ¬','ì¤‘êµ¬','ê°•ì„œêµ¬'] },
      { name: 'ëŒ€êµ¬', display: 'ëŒ€êµ¬', lat: 35.8714, lon: 128.6014, keywords: ['ëŒ€êµ¬','ìˆ˜ì„±êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ì¤‘êµ¬','ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬'] },
      { name: 'ì¸ì²œ', display: 'ì¸ì²œ', lat: 37.4563, lon: 126.7052, keywords: ['ì¸ì²œ','ë¯¸ì¶”í™€êµ¬','ì—°ìˆ˜êµ¬','ë‚¨ë™êµ¬','ë¶€í‰êµ¬','ê³„ì–‘êµ¬','ì„œêµ¬','ì¤‘êµ¬','ë™êµ¬','ê°•í™”êµ°','ì˜¹ì§„êµ°'] },
      { name: 'ê´‘ì£¼', display: 'ê´‘ì£¼', lat: 35.1595, lon: 126.8526, keywords: ['ê´‘ì£¼','ê´‘ì‚°êµ¬','ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬'] },
      { name: 'ëŒ€ì „', display: 'ëŒ€ì „', lat: 36.3504, lon: 127.3845, keywords: ['ëŒ€ì „','ìœ ì„±êµ¬','ëŒ€ë•êµ¬','ë™êµ¬','ì¤‘êµ¬','ì„œêµ¬'] },
      { name: 'ìš¸ì‚°', display: 'ìš¸ì‚°', lat: 35.5384, lon: 129.3114, keywords: ['ìš¸ì‚°','ìš¸ì£¼êµ°','ì¤‘êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬'] },
      { name: 'ì„¸ì¢…', display: 'ì„¸ì¢…', lat: 36.48, lon: 127.26, keywords: ['ì„¸ì¢…'] },
      { name: 'ì œì£¼', display: 'ì œì£¼', lat: 33.4996, lon: 126.5312, keywords: ['ì œì£¼','ì œì£¼ì‹œ'] },
      { name: 'ì„œê·€í¬', display: 'ì„œê·€í¬ (ì œì£¼)', lat: 33.2541, lon: 126.56, keywords: ['ì„œê·€í¬'] },
      // ê²½ê¸°ë„
      { name: 'ìˆ˜ì›', display: 'ìˆ˜ì› (ê²½ê¸°)', lat: 37.2636, lon: 127.0286, keywords: ['ìˆ˜ì›','ì¥ì•ˆêµ¬','ê¶Œì„ êµ¬','íŒ”ë‹¬êµ¬','ì˜í†µêµ¬'] },
      { name: 'ì„±ë‚¨', display: 'ì„±ë‚¨ (ê²½ê¸°)', lat: 37.42, lon: 127.1267, keywords: ['ì„±ë‚¨','ë¶„ë‹¹êµ¬','ìˆ˜ì •êµ¬','ì¤‘ì›êµ¬','ë¶„ë‹¹'] },
      { name: 'ê³ ì–‘', display: 'ê³ ì–‘ (ê²½ê¸°)', lat: 37.6584, lon: 126.832, keywords: ['ê³ ì–‘','ì¼ì‚°ë™êµ¬','ì¼ì‚°ì„œêµ¬','ë•ì–‘êµ¬','ì¼ì‚°'] },
      { name: 'ìš©ì¸', display: 'ìš©ì¸ (ê²½ê¸°)', lat: 37.2411, lon: 127.1776, keywords: ['ìš©ì¸','ì²˜ì¸êµ¬','ê¸°í¥êµ¬','ìˆ˜ì§€êµ¬'] },
      { name: 'í™”ì„±', display: 'í™”ì„± (ê²½ê¸°)', lat: 37.1996, lon: 126.8312, keywords: ['í™”ì„±','ë™íƒ„'] },
      { name: 'ë¶€ì²œ', display: 'ë¶€ì²œ (ê²½ê¸°)', lat: 37.5034, lon: 126.766, keywords: ['ë¶€ì²œ'] },
      { name: 'ì•ˆì‚°', display: 'ì•ˆì‚° (ê²½ê¸°)', lat: 37.3219, lon: 126.8309, keywords: ['ì•ˆì‚°','ìƒë¡êµ¬','ë‹¨ì›êµ¬'] },
      { name: 'ì•ˆì–‘', display: 'ì•ˆì–‘ (ê²½ê¸°)', lat: 37.3925, lon: 126.9269, keywords: ['ì•ˆì–‘','ë§Œì•ˆêµ¬','ë™ì•ˆêµ¬'] },
      { name: 'ë‚¨ì–‘ì£¼', display: 'ë‚¨ì–‘ì£¼ (ê²½ê¸°)', lat: 37.636, lon: 127.2165, keywords: ['ë‚¨ì–‘ì£¼'] },
      { name: 'í‰íƒ', display: 'í‰íƒ (ê²½ê¸°)', lat: 36.9921, lon: 127.1126, keywords: ['í‰íƒ'] },
      { name: 'ì‹œí¥', display: 'ì‹œí¥ (ê²½ê¸°)', lat: 37.38, lon: 126.803, keywords: ['ì‹œí¥'] },
      { name: 'íŒŒì£¼', display: 'íŒŒì£¼ (ê²½ê¸°)', lat: 37.7599, lon: 126.78, keywords: ['íŒŒì£¼'] },
      { name: 'ê¹€í¬', display: 'ê¹€í¬ (ê²½ê¸°)', lat: 37.6153, lon: 126.7156, keywords: ['ê¹€í¬'] },
      { name: 'ì˜ì •ë¶€', display: 'ì˜ì •ë¶€ (ê²½ê¸°)', lat: 37.7381, lon: 127.0337, keywords: ['ì˜ì •ë¶€'] },
      { name: 'ê´‘ì£¼ì‹œ', display: 'ê´‘ì£¼ (ê²½ê¸°)', lat: 37.4095, lon: 127.255, keywords: ['ê´‘ì£¼ì‹œ','ê²½ê¸°ê´‘ì£¼'] },
      { name: 'í•˜ë‚¨', display: 'í•˜ë‚¨ (ê²½ê¸°)', lat: 37.5393, lon: 127.2148, keywords: ['í•˜ë‚¨','ë¯¸ì‚¬'] },
      { name: 'êµ°í¬', display: 'êµ°í¬ (ê²½ê¸°)', lat: 37.3614, lon: 126.9352, keywords: ['êµ°í¬'] },
      { name: 'ì˜ì™•', display: 'ì˜ì™• (ê²½ê¸°)', lat: 37.3449, lon: 126.9685, keywords: ['ì˜ì™•'] },
      { name: 'ì˜¤ì‚°', display: 'ì˜¤ì‚° (ê²½ê¸°)', lat: 37.1498, lon: 127.0698, keywords: ['ì˜¤ì‚°'] },
      { name: 'ì´ì²œ', display: 'ì´ì²œ (ê²½ê¸°)', lat: 37.272, lon: 127.435, keywords: ['ì´ì²œ'] },
      { name: 'ì–‘ì£¼', display: 'ì–‘ì£¼ (ê²½ê¸°)', lat: 37.7853, lon: 127.0456, keywords: ['ì–‘ì£¼'] },
      { name: 'êµ¬ë¦¬', display: 'êµ¬ë¦¬ (ê²½ê¸°)', lat: 37.5943, lon: 127.1295, keywords: ['êµ¬ë¦¬'] },
      { name: 'ê´‘ëª…', display: 'ê´‘ëª… (ê²½ê¸°)', lat: 37.4784, lon: 126.8666, keywords: ['ê´‘ëª…'] },
      { name: 'ê³¼ì²œ', display: 'ê³¼ì²œ (ê²½ê¸°)', lat: 37.4292, lon: 126.9876, keywords: ['ê³¼ì²œ'] },
      { name: 'ë™ë‘ì²œ', display: 'ë™ë‘ì²œ (ê²½ê¸°)', lat: 37.9035, lon: 127.0607, keywords: ['ë™ë‘ì²œ'] },
      { name: 'í¬ì²œ', display: 'í¬ì²œ (ê²½ê¸°)', lat: 37.8949, lon: 127.2003, keywords: ['í¬ì²œ'] },
      { name: 'ì—¬ì£¼', display: 'ì—¬ì£¼ (ê²½ê¸°)', lat: 37.2983, lon: 127.6375, keywords: ['ì—¬ì£¼'] },
      { name: 'ì•ˆì„±', display: 'ì•ˆì„± (ê²½ê¸°)', lat: 37.0079, lon: 127.2797, keywords: ['ì•ˆì„±'] },
      { name: 'ì—°ì²œ', display: 'ì—°ì²œ (ê²½ê¸°)', lat: 38.0965, lon: 127.075, keywords: ['ì—°ì²œ'] },
      { name: 'ì–‘í‰', display: 'ì–‘í‰ (ê²½ê¸°)', lat: 37.4916, lon: 127.4876, keywords: ['ì–‘í‰'] },
      { name: 'ê°€í‰', display: 'ê°€í‰ (ê²½ê¸°)', lat: 37.8315, lon: 127.5096, keywords: ['ê°€í‰'] },
      // ê°•ì›
      { name: 'ì¶˜ì²œ', display: 'ì¶˜ì²œ (ê°•ì›)', lat: 37.8813, lon: 127.73, keywords: ['ì¶˜ì²œ'] },
      { name: 'ì›ì£¼', display: 'ì›ì£¼ (ê°•ì›)', lat: 37.3422, lon: 127.9202, keywords: ['ì›ì£¼'] },
      { name: 'ê°•ë¦‰', display: 'ê°•ë¦‰ (ê°•ì›)', lat: 37.7519, lon: 128.8761, keywords: ['ê°•ë¦‰'] },
      { name: 'ì†ì´ˆ', display: 'ì†ì´ˆ (ê°•ì›)', lat: 38.207, lon: 128.5918, keywords: ['ì†ì´ˆ'] },
      { name: 'ë™í•´', display: 'ë™í•´ (ê°•ì›)', lat: 37.5247, lon: 129.1143, keywords: ['ë™í•´'] },
      { name: 'íƒœë°±', display: 'íƒœë°± (ê°•ì›)', lat: 37.1641, lon: 128.9856, keywords: ['íƒœë°±'] },
      { name: 'ì‚¼ì²™', display: 'ì‚¼ì²™ (ê°•ì›)', lat: 37.45, lon: 129.1651, keywords: ['ì‚¼ì²™'] },
      { name: 'í™ì²œ', display: 'í™ì²œ (ê°•ì›)', lat: 37.6972, lon: 127.8886, keywords: ['í™ì²œ'] },
      { name: 'íš¡ì„±', display: 'íš¡ì„± (ê°•ì›)', lat: 37.4885, lon: 127.9847, keywords: ['íš¡ì„±'] },
      { name: 'ì˜ì›”', display: 'ì˜ì›” (ê°•ì›)', lat: 37.1837, lon: 128.4617, keywords: ['ì˜ì›”'] },
      { name: 'í‰ì°½', display: 'í‰ì°½ (ê°•ì›)', lat: 37.3704, lon: 128.3906, keywords: ['í‰ì°½'] },
      { name: 'ì •ì„ ', display: 'ì •ì„  (ê°•ì›)', lat: 37.3808, lon: 128.6608, keywords: ['ì •ì„ '] },
      { name: 'ì² ì›', display: 'ì² ì› (ê°•ì›)', lat: 38.1465, lon: 127.3133, keywords: ['ì² ì›'] },
      // ì¶©ë¶
      { name: 'ì²­ì£¼', display: 'ì²­ì£¼ (ì¶©ë¶)', lat: 36.6424, lon: 127.489, keywords: ['ì²­ì£¼','ìƒë‹¹êµ¬','ì„œì›êµ¬','í¥ë•êµ¬','ì²­ì›êµ¬'] },
      { name: 'ì¶©ì£¼', display: 'ì¶©ì£¼ (ì¶©ë¶)', lat: 36.991, lon: 127.9259, keywords: ['ì¶©ì£¼'] },
      { name: 'ì œì²œ', display: 'ì œì²œ (ì¶©ë¶)', lat: 37.1325, lon: 128.191, keywords: ['ì œì²œ'] },
      { name: 'ë³´ì€', display: 'ë³´ì€ (ì¶©ë¶)', lat: 36.489, lon: 127.7293, keywords: ['ë³´ì€'] },
      { name: 'ì˜¥ì²œ', display: 'ì˜¥ì²œ (ì¶©ë¶)', lat: 36.306, lon: 127.5714, keywords: ['ì˜¥ì²œ'] },
      { name: 'ì˜ë™', display: 'ì˜ë™ (ì¶©ë¶)', lat: 36.175, lon: 127.7764, keywords: ['ì˜ë™'] },
      { name: 'ì§„ì²œ', display: 'ì§„ì²œ (ì¶©ë¶)', lat: 36.8553, lon: 127.4356, keywords: ['ì§„ì²œ'] },
      // ì¶©ë‚¨
      { name: 'ì²œì•ˆ', display: 'ì²œì•ˆ (ì¶©ë‚¨)', lat: 36.8151, lon: 127.1139, keywords: ['ì²œì•ˆ','ë™ë‚¨êµ¬','ì„œë¶êµ¬'] },
      { name: 'ì•„ì‚°', display: 'ì•„ì‚° (ì¶©ë‚¨)', lat: 36.7898, lon: 127.0018, keywords: ['ì•„ì‚°'] },
      { name: 'ì„œì‚°', display: 'ì„œì‚° (ì¶©ë‚¨)', lat: 36.7845, lon: 126.4503, keywords: ['ì„œì‚°'] },
      { name: 'ë‹¹ì§„', display: 'ë‹¹ì§„ (ì¶©ë‚¨)', lat: 36.8896, lon: 126.6463, keywords: ['ë‹¹ì§„'] },
      { name: 'ë…¼ì‚°', display: 'ë…¼ì‚° (ì¶©ë‚¨)', lat: 36.1872, lon: 127.0986, keywords: ['ë…¼ì‚°'] },
      { name: 'ê³µì£¼', display: 'ê³µì£¼ (ì¶©ë‚¨)', lat: 36.4465, lon: 127.119, keywords: ['ê³µì£¼'] },
      { name: 'ë³´ë ¹', display: 'ë³´ë ¹ (ì¶©ë‚¨)', lat: 36.3334, lon: 126.6128, keywords: ['ë³´ë ¹'] },
      { name: 'í™ì„±', display: 'í™ì„± (ì¶©ë‚¨)', lat: 36.6013, lon: 126.6603, keywords: ['í™ì„±'] },
      // ì „ë¶
      { name: 'ì „ì£¼', display: 'ì „ì£¼ (ì „ë¶)', lat: 35.8242, lon: 127.148, keywords: ['ì „ì£¼','ì™„ì‚°êµ¬','ë•ì§„êµ¬'] },
      { name: 'ìµì‚°', display: 'ìµì‚° (ì „ë¶)', lat: 35.9483, lon: 126.9576, keywords: ['ìµì‚°'] },
      { name: 'êµ°ì‚°', display: 'êµ°ì‚° (ì „ë¶)', lat: 35.9676, lon: 126.7369, keywords: ['êµ°ì‚°'] },
      { name: 'ì •ì', display: 'ì •ì (ì „ë¶)', lat: 35.5699, lon: 126.8558, keywords: ['ì •ì'] },
      { name: 'ë‚¨ì›', display: 'ë‚¨ì› (ì „ë¶)', lat: 35.4164, lon: 127.3906, keywords: ['ë‚¨ì›'] },
      { name: 'ê¹€ì œ', display: 'ê¹€ì œ (ì „ë¶)', lat: 35.8037, lon: 126.8808, keywords: ['ê¹€ì œ'] },
      // ì „ë‚¨
      { name: 'ì—¬ìˆ˜', display: 'ì—¬ìˆ˜ (ì „ë‚¨)', lat: 34.7604, lon: 127.6622, keywords: ['ì—¬ìˆ˜'] },
      { name: 'ìˆœì²œ', display: 'ìˆœì²œ (ì „ë‚¨)', lat: 34.9506, lon: 127.4873, keywords: ['ìˆœì²œ'] },
      { name: 'ëª©í¬', display: 'ëª©í¬ (ì „ë‚¨)', lat: 34.8118, lon: 126.3922, keywords: ['ëª©í¬'] },
      { name: 'ê´‘ì–‘', display: 'ê´‘ì–‘ (ì „ë‚¨)', lat: 34.9407, lon: 127.6957, keywords: ['ê´‘ì–‘'] },
      { name: 'ë‚˜ì£¼', display: 'ë‚˜ì£¼ (ì „ë‚¨)', lat: 35.0159, lon: 126.7104, keywords: ['ë‚˜ì£¼'] },
      // ê²½ë¶
      { name: 'í¬í•­', display: 'í¬í•­ (ê²½ë¶)', lat: 36.019, lon: 129.3435, keywords: ['í¬í•­'] },
      { name: 'êµ¬ë¯¸', display: 'êµ¬ë¯¸ (ê²½ë¶)', lat: 36.1196, lon: 128.3446, keywords: ['êµ¬ë¯¸'] },
      { name: 'ê²½ì£¼', display: 'ê²½ì£¼ (ê²½ë¶)', lat: 35.8562, lon: 129.2248, keywords: ['ê²½ì£¼'] },
      { name: 'ê¹€ì²œ', display: 'ê¹€ì²œ (ê²½ë¶)', lat: 36.1398, lon: 128.1136, keywords: ['ê¹€ì²œ'] },
      { name: 'ì•ˆë™', display: 'ì•ˆë™ (ê²½ë¶)', lat: 36.5684, lon: 128.7294, keywords: ['ì•ˆë™'] },
      { name: 'ì˜ì£¼', display: 'ì˜ì£¼ (ê²½ë¶)', lat: 36.8057, lon: 128.6239, keywords: ['ì˜ì£¼'] },
      { name: 'ê²½ì‚°', display: 'ê²½ì‚° (ê²½ë¶)', lat: 35.8251, lon: 128.7416, keywords: ['ê²½ì‚°'] },
      // ê²½ë‚¨
      { name: 'ì°½ì›', display: 'ì°½ì› (ê²½ë‚¨)', lat: 35.228, lon: 128.6811, keywords: ['ì°½ì›','ë§ˆì‚°','ì§„í•´'] },
      { name: 'ê¹€í•´', display: 'ê¹€í•´ (ê²½ë‚¨)', lat: 35.2285, lon: 128.8894, keywords: ['ê¹€í•´'] },
      { name: 'ì§„ì£¼', display: 'ì§„ì£¼ (ê²½ë‚¨)', lat: 35.18, lon: 128.1076, keywords: ['ì§„ì£¼'] },
      { name: 'ì–‘ì‚°', display: 'ì–‘ì‚° (ê²½ë‚¨)', lat: 35.335, lon: 129.0374, keywords: ['ì–‘ì‚°'] },
      { name: 'ê±°ì œ', display: 'ê±°ì œ (ê²½ë‚¨)', lat: 34.8806, lon: 128.6211, keywords: ['ê±°ì œ'] },
      { name: 'í†µì˜', display: 'í†µì˜ (ê²½ë‚¨)', lat: 34.8545, lon: 128.433, keywords: ['í†µì˜'] },
    ];

    let selectedLocation = null;

    function searchLocation(query) {
      const q = query.trim().toLowerCase();
      if (!q) return [];
      return LOCATION_SEARCH_DATA
        .filter(loc => loc.keywords.some(kw => kw.includes(q)) || loc.name.includes(q) || loc.display.includes(q))
        .slice(0, 8);
    }

    function renderLocationResults(results, query) {
      const container = document.getElementById('location-results');
      if (results.length === 0) {
        container.classList.remove('show');
        return;
      }
      container.innerHTML = results.map((loc, i) => {
        const matchedKw = loc.keywords.find(kw => kw.includes(query.trim().toLowerCase()) && kw !== loc.name);
        const matchHint = matchedKw ? '<div class="result-match">' + matchedKw + ' â†’ ' + loc.name + '</div>' : '';
        return '<div class="location-result-item" data-index="' + i + '"><div class="result-name">' + loc.display + '</div>' + matchHint + '</div>';
      }).join('');
      container.classList.add('show');

      container.querySelectorAll('.location-result-item').forEach(item => {
        item.onclick = function() {
          const idx = parseInt(this.dataset.index);
          selectLocation(results[idx]);
        };
      });
    }

    function selectLocation(loc) {
      selectedLocation = loc;
      document.getElementById('location-search-wrapper').style.display = 'none';
      document.getElementById('location-selected').style.display = '';
      document.getElementById('location-display-name').textContent = loc.display;
      document.getElementById('location-results').classList.remove('show');
    }

    function resetLocationSearch() {
      selectedLocation = null;
      document.getElementById('location-search-wrapper').style.display = '';
      document.getElementById('location-selected').style.display = 'none';
      var searchInput = document.getElementById('location-search');
      searchInput.value = '';
      searchInput.focus();
    }

    document.getElementById('location-search').addEventListener('input', function() {
      var results = searchLocation(this.value);
      renderLocationResults(results, this.value);
    });

    document.getElementById('location-search').addEventListener('focus', function() {
      if (this.value.trim()) {
        var results = searchLocation(this.value);
        renderLocationResults(results, this.value);
      }
    });

    document.addEventListener('click', function(e) {
      var wrapper = document.getElementById('location-search-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        document.getElementById('location-results').classList.remove('show');
      }
    });

    // --- Single chip selector ---

    const METHOD_DESCS = {
      '80_20': '80% ì €ê°•ë„ + 20% ê³ ê°•ë„. ë¶€ìƒ ì—†ì´ ê¾¸ì¤€í•œ ê¸°ë¡ í–¥ìƒ.',
      'jack_daniels': 'VDOT ê¸°ë°˜ 5ë‹¨ê³„ í˜ì´ìŠ¤. ê³¼í•™ì ì´ê³  ì²´ê³„ì ì¸ í›ˆë ¨.',
      'maf': '180-ë‚˜ì´ ì‹¬ë°•ìˆ˜ ì´í•˜ë¡œë§Œ í›ˆë ¨. ìœ ì‚°ì†Œ ê¸°ì´ˆ ì²´ë ¥ êµ¬ì¶•.',
      'pfitzinger': 'ê³ ë³¼ë¥¨ + ì—­ì£¼ê¸°í™”. ë§ˆë¼í†¤ ê¸°ë¡ í–¥ìƒì— ì§‘ì¤‘.',
      'hansons': 'ëˆ„ì  í”¼ë¡œ ì² í•™. ì£¼ 6ì¼, ë¡±ëŸ° 26km ìƒí•œ.',
      'galloway': 'ë‹¬ë¦¬ê¸°/ê±·ê¸° êµëŒ€. ë¶€ìƒ ìœ„í—˜ ìµœì†Œí™”, ì´ˆë³´ ì¹œí™”.',
      'lydiard': 'ìœ ì‚°ì†Œ ë² ì´ìŠ¤ â†’ ìŠ¤í”¼ë“œ ì£¼ê¸°í™”. ì—˜ë¦¬íŠ¸/ì¤€ì—˜ë¦¬íŠ¸ìš©.',
      'norwegian': 'ì´ì¤‘ ì—­ì¹˜(Double Threshold). ì—­ì¹˜ ëŠ¥ë ¥ ê·¹ëŒ€í™” ìµœì‹  íŠ¸ë Œë“œ.',
    };

    function selectSingleChip(el, groupId) {
      const group = document.getElementById(groupId);
      const wasSelected = el.classList.contains('selected');
      group.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      if (!wasSelected) {
        el.classList.add('selected');
      }
      // í›ˆë ¨ë²• ì„¤ëª… í‘œì‹œ
      const descEl = document.getElementById('method-desc');
      if (descEl) {
        const val = el.classList.contains('selected') ? el.dataset.value : null;
        if (val === 'coach_recommend') {
          descEl.textContent = 'í”„ë¡œí•„ ì™„ì„± í›„ ì½”ì¹˜ê°€ ë§ì¶¤ í›ˆë ¨ë²•ì„ ì¶”ì²œí•´ë“œë ¤ìš”.';
        } else {
          descEl.textContent = val ? METHOD_DESCS[val] || '' : '';
        }
      }
    }

    // --- Card selector ---

    function selectCard(el, groupId) {
      const group = document.getElementById(groupId);
      group.querySelectorAll('.card-option').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    // --- Collect data ---

    function collectSurveyData() {
      const data = { survey_version: '1' };

      // Step 1
      const goalText = document.getElementById('goal-text').value.trim();
      if (goalText) data.goal_text = goalText;

      const targetDate = document.getElementById('target-date').value.trim();
      if (targetDate) data.target_date = targetDate;

      // Step 2
      const freqTab = document.querySelector('.tab-option.selected');
      if (freqTab) data.weekly_frequency = freqTab.dataset.value;

      const selectedTimeChips = document.querySelectorAll('#run-time-chips .chip.selected');
      if (selectedTimeChips.length > 0) {
        data.run_times = Array.from(selectedTimeChips).map(c => c.dataset.value);
      }

      const patternNote = document.getElementById('run-pattern-note').value.trim();
      if (patternNote) data.run_pattern_note = patternNote;

      // Step 2: location
      if (selectedLocation) {
        data.default_location = { name: selectedLocation.name, lat: selectedLocation.lat, lon: selectedLocation.lon };
      }

      // Step 3
      const methodCard = document.querySelector('#method-cards .card-option.selected');
      if (methodCard) data.training_method = methodCard.dataset.value;

      // Step 4
      const priorityCard = document.querySelector('#priority-cards .card-option.selected');
      if (priorityCard) data.priority = priorityCard.dataset.value;

      const styleCard = document.querySelector('#style-cards .card-option.selected');
      if (styleCard) data.plan_style = styleCard.dataset.value;

      const additionalNote = document.getElementById('additional-note').value.trim();
      if (additionalNote) data.additional_note = additionalNote;

      return data;
    }

    // --- Submit ---

    async function submitSurvey() {
      const surveyData = collectSurveyData();

      const user = tg?.initDataUnsafe?.user;
      if (!user?.id) {
        showComplete();
        return;
      }

      const btnSubmit = document.getElementById('btn-submit');
      if (btnSubmit) {
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '<span class="spinner"></span>ì €ì¥ ì¤‘...';
      }
      hideError();

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'save_survey',
            telegram_user_id: user.id,
            init_data: tg.initData,
            survey: surveyData,
          }),
        });

        const result = await response.json();

        if (response.ok && result.success) {
          showComplete();
        } else {
          showError(result.error || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          resetSubmitBtn();
        }
      } catch (err) {
        console.error('Survey submit error:', err);
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œì—ë„ ì™„ë£Œ ì²˜ë¦¬ (ì„¤ë¬¸ì€ í•„ìˆ˜ê°€ ì•„ë‹˜)
        showComplete();
      }
    }

    function showComplete() {
      goToStep('complete');
      setTimeout(() => {
        if (tg) tg.close();
      }, 2000);
    }

    function showError(msg) {
      const el = document.getElementById('error-msg');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function hideError() {
      const el = document.getElementById('error-msg');
      if (el) el.style.display = 'none';
    }

    function resetSubmitBtn() {
      const btnSubmit = document.getElementById('btn-submit');
      if (btnSubmit) {
        btnSubmit.disabled = false;
        btnSubmit.textContent = 'ì™„ë£Œ';
      }
    }
  </script>
</body>
</html>
